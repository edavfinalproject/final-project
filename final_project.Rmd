---
title: "Final Project"
author: "Names and Unis....."
date:   "April 24, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
                      message = FALSE)
```

### Introduction

Explain why you chose this topic, and the questions you are interested in studying.

List team members and a description of how each contributed to the project.

* How do we think about the realtionship between energy use and population
* If no visible correlation, what does that mean? Is it simply that there are other stronger factors we do not know about?
* Do all countries follow the same path of energy and population growth?
* Is population growth the biggest threat to sustainable energy consumption?
* Visualize populaiton growth vs energy growth of various countries

### Description of Data

Describe how the data was collected, how you accessed it, and any other noteworthy features.

Data is from the world bank....


```{r}
# Install and/or load required libraries
needed_packages <- c("data.table", "tidyverse")

for (p in needed_packages) {
     if (!(p %in% installed.packages())){
          install.packages(p)
     }
}

library(data.table)
library(tidyverse)
```

Data sources used:

* Access to electricity (% of population)
* Population growth (annual %)
* Population growth (annual %)


```{r, results = hide}
### Download, unzip, and read in data stored as CSV files

#TODO Tidy the data

# Links for data sources
pop_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.GROW?downloadformat=csv"
energy_zip <- "http://api.worldbank.org/v2/en/indicator/EG.USE.PCAP.KG.OE?downloadformat=csv"
electricity_access_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.ACCS.ZS?downloadformat=csv"
renewable_consumption_zip <- "http://api.worldbank.org/v2/en/indicator/EG.FEC.RNEW.ZS?downloadformat=csv"
renewable_energy_output_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.RNEW.ZS?downloadformat=csv"

elec_prod_renewable_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.RNWX.ZS?downloadformat=csv"
elec_prod_coal_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.COAL.ZS?downloadformat=csv"
elec_prod_nuclear_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.NUCL.ZS?downloadformat=csv"
elec_prod_oil_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.PETR.ZS?downloadformat=csv"
elec_prod_hydro_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.HYRO.ZS?downloadformat=csv"
elec_prod_natural_gas_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.NGAS.ZS?downloadformat=csv"



# Download and unzip data sources
zip_list <- c(pop_zip, energy_zip, electricity_access_zip,
              renewable_consumption_zip, renewable_energy_output_zip,
              elec_prod_renewable_zip, elec_prod_coal_zip,
              elec_prod_nuclear_zip, elec_prod_oil_zip,
              elec_prod_hydro_zip, elec_prod_natural_gas_zip)

for (i in zip_list){
    
    td = tempdir()
    tf = tempfile(tmpdir=td, fileext=".zip")
    
    download.file(i, tf, mode = "wb")
    zip_folder <- unzip(tf, list = TRUE)
    
    for (j in seq_along(zip_folder$Name)) {
        
        file_name = unzip(tf, list = TRUE)$Name[j]
        unzip(tf, files = file_name, exdir = td, overwrite = TRUE)
        file_path <- file.path(td, file_name)
        csv <- fread(file_path)
        new_header <- str_to_upper(gsub(pattern = " ", replacement = "_", x = names(csv)))
        setnames(csv, new_header)
        assign(file_name, csv)
        
    }
    
}
```

```{r}
# Simplify data.frame names

pop_df <-  API_SP.POP.GROW_DS2_en_csv_v2.csv
rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)

pop_meta <- Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv
rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)

energy_df <- API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)

energy_meta <- Metadata_Country_API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
rm(Metadata_Country_API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)

elec_access_df <- API_EG.ELC.ACCS.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.ACCS.ZS_DS2_en_csv_v2.csv)

elec_access_meta <- Metadata_Country_API_EG.ELC.ACCS.ZS_DS2_en_csv_v2.csv
rm(Metadata_Country_API_EG.ELC.ACCS.ZS_DS2_en_csv_v2.csv)


# Energy Production Data
elec_prod_coal <- API_EG.ELC.COAL.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.COAL.ZS_DS2_en_csv_v2.csv)

elec_prod_hydro <- API_EG.ELC.HYRO.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.HYRO.ZS_DS2_en_csv_v2.csv)

elec_prod_natural_gas <- API_EG.ELC.NGAS.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.NGAS.ZS_DS2_en_csv_v2.csv)

elec_prod_nuclear <- API_EG.ELC.NUCL.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.NUCL.ZS_DS2_en_csv_v2.csv)

elec_prod_oil <- API_EG.ELC.PETR.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.PETR.ZS_DS2_en_csv_v2.csv)

elec_prod_renewable <- API_EG.ELC.RNEW.ZS_DS2_en_csv_v2.csv
rm(API_EG.ELC.RNEW.ZS_DS2_en_csv_v2.csv)






# elec_prod_renewable_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.RNWX.ZS?downloadformat=csv"
# elec_prod_coal_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.COAL.ZS?downloadformat=csv"
# elec_prod_nuclear_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.NUCL.ZS?downloadformat=csv"
# elec_prod_oil_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.PETR.ZS?downloadformat=csv"
# elec_prod_hydro_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.HYRO.ZS?downloadformat=csv"
# elec_prod_natural_gas_zip <- "http://api.worldbank.org/v2/en/indicator/EG.ELC.NGAS.ZS?downloadformat=csv"

```



```{r}

pop_meta <- pop_meta[, .(COUNTRY_CODE, REGION, INCOMEGROUP)]

pop_df <- pop_df[,!"V63"]


pop_country_year <- pop_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "POP_GROWTH_RATE", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

energy_country_year <- energy_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "ENERGY_USE", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

elec_access_country_year <- elec_access_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "ELECTRICITY_ACCESS", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

```


### Analysis of Data Quality

Provide a detailed, well-organized description of data quality, including textual description, graphs, and code.

* For some years, total production by region is much higher than %100

 

### Main Analysis (Exploratory Data Analysis)

Provide a detailed, well-organized description of your findings, including textual description, graphs, and code.  Your focus should be on both the results and the process. Include, as reasonable and relevant, approaches that didn't work, challenges, the data cleaning process, etc.


#### Distribution
- Bar chart of population and energy use by country
- Mosaic plot of energy vs population 

#### Is there a relationship?
- Scatter of energy per capita vs population pet capita
- scatter population total vs energy total
- Energy per capita vs population
- Could add diagonal line for all above
- alluvial diagram staring with total population and going to energy.


#### Trends over time
- X axis is year. Y axis is energy use. Line thickness is population.

#### GDP, happinesss/quality of life score (if time/interest)

Hey guys I have been slowly adding notes and making an outline in an rmd file in GitHub. Feel free to keep adding Donny the time it's crunch time we have a lot of ideas. Also let me know if you are having any GitHub issues 
  
  
```{r}
# Scatter plot of energy use and growth rate by country-year
pop_energy_year <- 
    left_join(pop_country_year, energy_country_year, by = "COUNTRY_YEAR") %>%
    select(COUNTRY_YEAR, POP_GROWTH_RATE, ENERGY_USE) %>%
    filter(POP_GROWTH_RATE != '' & ENERGY_USE != '') %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
    mutate(ENERGY_USE = as.numeric(ENERGY_USE))

ggplot(pop_energy_year, aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point()


# Hard to tell what's going on without any subsetting.
pop_elec_year <- 
    left_join(pop_country_year, elec_access_country_year, by = "COUNTRY_YEAR") %>%
    select(COUNTRY_YEAR, POP_GROWTH_RATE, ELECTRICITY_ACCESS) %>%
    filter(POP_GROWTH_RATE != '' & ELECTRICITY_ACCESS != '') %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
    mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))

ggplot(pop_elec_year, aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
    geom_point()

ggplot(pop_elec_year %>% filter(POP_GROWTH_RATE >= 5), 
       aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
    geom_point()

# Counts of countries by region and income group
ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(Region)) +
    geom_bar() + coord_flip()

ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(IncomeGroup)) +
    geom_bar() + coord_flip()


# Population growth rate over time by geographic region
pop_year_world <- pop_country_year %>%
    filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS")) %>%
    mutate(YEAR = as.integer(YEAR)) %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE))



ggplot(pop_year_world, 
       aes(YEAR, POP_GROWTH_RATE, color = COUNTRY_CODE)) + geom_line()

elec_access_year_world <- elec_access_country_year %>%
    filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS")) %>%
    mutate(YEAR = as.integer(YEAR)) %>%
    mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))


# No recorded values before 1990
ggplot(elec_access_year_world %>% filter(YEAR >= 1990), 
       aes(YEAR, ELECTRICITY_ACCESS, color = COUNTRY_CODE)) + geom_line()

```

```{r}

world_prod_coal <- elec_prod_coal %>%
     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS", "WLD"))

world_prod_hydro <- elec_prod_hydro %>%
     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS", "WLD"))

world_prod_natural_gas <- elec_prod_natural_gas %>%
     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS", "WLD"))

world_prod_nuclear <- elec_prod_nuclear %>%
     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS", "WLD"))

world_prod_oil <- elec_prod_oil %>%
     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS", "WLD"))

world_prod_renewable <- elec_prod_renewable %>%
     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS", "WLD"))


world_prod_total <- rbind(world_prod_coal, world_prod_hydro, 
                          world_prod_natural_gas, world_prod_nuclear,
                          world_prod_oil, world_prod_renewable)

world_prod_total <- world_prod_total %>%
     gather(key = "YEAR", value = "VALUE", -COUNTRY_NAME, -COUNTRY_CODE,
            -INDICATOR_NAME, -INDICATOR_CODE) %>%
     mutate(VALUE = as.numeric(VALUE)) %>%
     mutate(YEAR = as.integer(YEAR)) %>%
     left_join(y = pop_meta) %>%
     drop_na()

# world_prod_total <- na.rm(world_prod_total)


ggplot(world_prod_total %>% filter(COUNTRY_CODE == "WLD"),
       aes(YEAR, VALUE, color = INDICATOR_CODE)) +
     geom_line()

ggplot(world_prod_total,
       aes(YEAR, VALUE, color = INDICATOR_CODE)) +
     geom_line() + facet_wrap(facets = "COUNTRY_NAME")


# Data issue - for some years, total production by region is way above %100
world_prod_total %>% 
     group_by(COUNTRY_CODE, YEAR) %>% 
     summarize(total = sum(VALUE)) %>%
     arrange(-total)

```




### Executive Summary (Presentation-style)

Note: "Presentation" here refers to the style of graph, that is, graphs that are cleaned up for presentation, as opposed to the rough ones we often use for exploratory data analysis. You do not have to present your work to the class! However, you may choose to present your work as your community contribution, in which case you need to email me to set a date before the community contribution due date (Apr 3). (The presentation itself may be later.)

Provide a short nontechnical summary of the most revealing findings of your analysis  written for a nontechnical audience. The length should be approximately two pages (if we were using pages...) Take extra care to clean up your graphs, ensuring that best practices for presentation are followed.

 

### Conclusion

Discuss limitations and future directions, lessons learned.