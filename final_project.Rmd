---
title: "Final Project"
author: "Names and Unis....."
date:   "April 24, 2018"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
                      message = FALSE)
```


### Introduction

The debate about whether human intervention is causing climate change is ending, but the search for how to avert its most harmful affects is just beginning. One of the primary casues of climate change is our burning of Fossil Fuels, which has been steadily growithing as showing in figure 1.

In the important book "Prosperity Without Growth" the Author Tim Jackson we must find a way to grow our prosperity, without continuing to use more and more resources. Keeping on the same trajectory is ultimitely unsustainable in that it will have catestrophic affects to our climate, or the resources will simply run out.

Many propoponts will say the problem is population. If we can find a way to stop population growth we could stop the growth of energy and become a more sustainable society. 

However, our team thinks this claim needs testing. Is it fair to blame the developing countries with high population growth when many western countires, especially the USA, are consuming far more energy per person? Does the correlation of population and energy shown above still hold true when all countries are not included? We believe exploratory data analysis is a fantastic tool to help answer these questions, and therefore **the primary goal of this project is to explore and define the characteristics of the relationship between energy use and population over time.** 

A secondary purpose of the project and presentaiton to the class is to showcase and important field that needs Data Science. In a field dominated by finance, advertising, marketing, sales, and tech for the sake of tech, we claim there is more to what a Data Scientist can do.


# TODO: List team members and a description of how each contributed to the project.
Our team includes:


* David Schemitsch
* Isaac Wainstein
* Wyatt Ford - 

### Description of Data

Our project uses three datasets below published by the [World Bank](https://data.worldbank.org/). Each of these datasets contain per country data from 1960 through 2016. 

  1. Population, total
  2. Population growth (annual %)
  3. Energy use (kg of oil equivalent per capita)

In addition to these three dataset we added metadata of region and income group. We determined that including more data at this time would bring too much complexity for the scope of this project. However, we discuss additoinal metadata as part of the conclusion in the Future Work section.

The data was gathered and accessed using the World Bank's API, cleaned, and combined into one tidy dataframe. Making the tidy dataframe first was critical to collaboration. It allowed us all to have time to explore the data instead of waiting for a final dataset. Also, it made sure the code for the graphs would not change as the data format changed. Finally, it allowed us to easily make graphs with the data organized in the tidy format. Hence, having the dataset was large part of what made this project happen, and thus leads to future work of an R package discussed in the Future Work section.

The code to pull the data and put it in a data frame are below. We explored two ways to access the data. Our initial method was to identify the URLs that link to the three datasets, then loop through those URLs to download, unzip, and read the data into R for processing. Due to the API's intermittant downtime, our next process for accessing the data was to use the [`WDI`](https://cran.r-project.org/web/packages/WDI/index.html) package. One advantage to using this package is that the data were already in long format. With the former method, we needed to convert the data frames from wide format.

When processing the data, we only kept the attributes we were interested in keeping, namely country name and code, year, region, and income group. The attribute names were cleaned up for consistency, and attributes were added to identify the indicator type (e.g. "Population growth (annual %)"). Next, the three data frames were unioned together into one tidy data frame. Lastly, we needed to remove rows that represented various collections of countries as identified by the World Bank (e.g. "Small states", "European Union"). While it would be interesting to see how these bins of countries interacted with the data, we needed to limit the scope of our exploration to geographic region and income group for the brevity's sake. 

```{r Install and/or load required libraries}
# Install and/or load required libraries
needed_packages <- c("data.table", "tidyverse", "shiny", "WDI", "extracat")

for (p in needed_packages) {
     if (!(p %in% installed.packages())){
          install.packages(p)
     }
    library(p, character.only = TRUE)
}

# library(data.table)
# library(tidyverse)
# library(shiny)
```

```{r download World Bank data via the WDI package}
 # Alternate way to download World Bank data via the WDI package

meta_df <- data.frame(WDI_data$country)
meta_df <- select(meta_df, iso3c, country, region, income)
setnames(meta_df, c("COUNTRY_CODE", "COUNTRY_NAME", "REGION", "INCOME"))

pop_growth_df <- WDI(country = "all", indicator = "SP.POP.GROW", 
                     start = 1960, end = 2017, extra = TRUE)
pop_growth_df <- select(pop_growth_df, country, SP.POP.GROW, year, iso3c, region, income)
setnames(pop_growth_df, c("COUNTRY_NAME", "VALUE", "YEAR", 
                          "COUNTRY_CODE", "REGION", "INCOMEGROUP"))
pop_growth_df <- pop_growth_df %>% mutate(INDICATOR_NAME = "Population growth (annual %)") %>%
    mutate(INDICATOR_CODE = "SP.POP.GROW")


pop_df <- WDI(country = "all", indicator = "SP.POP.TOTL", 
                     start = 1960, end = 2017, extra = TRUE)
pop_df <- select(pop_df, country, SP.POP.TOTL, year, iso3c, region, income)
setnames(pop_df, c("COUNTRY_NAME", "VALUE", "YEAR", 
                   "COUNTRY_CODE", "REGION", "INCOMEGROUP"))
pop_df <- pop_df %>% mutate(INDICATOR_NAME = "Population, total") %>%
    mutate(INDICATOR_CODE = "SP.POP.TOTL")



energy_df <- WDI(country = "all", indicator = "EG.USE.PCAP.KG.OE", 
                     start = 1960, end = 2017, extra = TRUE)
energy_df <- select(energy_df, country, EG.USE.PCAP.KG.OE, year, iso3c, region, income)
setnames(energy_df, c("COUNTRY_NAME", "VALUE", "YEAR", 
                      "COUNTRY_CODE", "REGION", "INCOMEGROUP"))
energy_df <- energy_df %>% mutate(INDICATOR_NAME = "Energy use (kg of oil equivalent per capita)") %>%
    mutate(INDICATOR_CODE = "EG.USE.PCAP.KG.OE")

tidy_pop_energy <- rbind(pop_growth_df, pop_df, energy_df)

tidy_pop_energy <- tidy_pop_energy %>% 
    mutate(YEAR = as.numeric(YEAR)) %>%
    mutate(VALUE = as.numeric(VALUE))

not_country = c("Arab World", "Central Europe and the Baltics", "Early-demographic dividend", "Europe & Central Asia (excluding high income)", "Euro area", "Fragile and conflict affected situations", "Heavily indebted poor countries (HIPC)", "IBRD only","IDA total", "Not classified", "Latin America & Caribbean (excluding high income)", "Latin America & Caribbean", "Low income", "Low & middle income", "Late-demographic dividend", "Middle income", "North America", "Post-demographic dividend", "Small states", "East Asia & Pacific (IDA & IBRD countries)", "Latin America & the Caribbean (IDA & IBRD countries)", "Middle East & North Africa (IDA & IBRD countries)", "South Asia (IDA & IBRD)", "World", "Upper middle income", "Sub-Saharan Africa (IDA & IBRD countries)", "Europe & Central Asia (IDA & IBRD countries)", "Sub-Saharan Africa", "Sub-Saharan Africa (excluding high income)", "Pacific island small states", "Pre-demographic dividend", "Other small states", "OECD members", "Middle East & North Africa (excluding high income)", "Middle East & North Africa", "Lower middle income", "Least developed countries: UN classification", "IDA only", "IDA blend", "IDA & IBRD total", "High income", "European Union", "Europe & Central Asia", "East Asia & Pacific", "East Asia & Pacific (excluding high income)", "Caribbean small states", "South Asia")

tidy_pop_energy <- filter(tidy_pop_energy, !COUNTRY_NAME %in% not_country)

tidy_pop_energy <- tidy_pop_energy %>% arrange(COUNTRY_NAME)

# tidy_pop_energy <- tidy_pop_energy %>% 
#     gather(key = "YEAR", value = "VALUE", -COUNTRY_CODE, -COUNTRY_NAME,
#            -INDICATOR_NAME, -INDICATOR_CODE, -REGION, -INCOMEGROUP) %>%
#     mutate(YEAR = as.numeric(YEAR)) %>%
#     mutate(VALUE = as.numeric(VALUE))


```


```{r Download, unzip, and read in data stored as CSV files, results="hide"}
# 
# ### Download, unzip, and read in data stored as CSV files
# 
# #TODO Tidy the data
# 
# # Links for data sources
# pop_growth_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.GROW?downloadformat=csv"
# pop_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.TOTL?downloadformat=csv"
# energy_zip <- "http://api.worldbank.org/v2/en/indicator/EG.USE.PCAP.KG.OE?downloadformat=csv"
# 
# # Download and unzip data sources
# zip_list <- c(pop_growth_zip, pop_zip, energy_zip)
# 
# for (i in zip_list){
#     
#     td = tempdir()
#     tf = tempfile(tmpdir=td, fileext=".zip")
#     
#     download.file(i, tf, mode = "wb")
#     zip_folder <- unzip(tf, list = TRUE)
#     
#     for (j in seq_along(zip_folder$Name)) {
#         
#         file_name = unzip(tf, list = TRUE)$Name[j]
#         unzip(tf, files = file_name, exdir = td, overwrite = TRUE)
#         file_path <- file.path(td, file_name)
#         csv <- fread(file_path)
#         new_header <- str_to_upper(gsub(pattern = " ", replacement = "_", x = names(csv)))
#         setnames(csv, new_header)
#         assign(file_name, csv)
#         
#     }
#     
# }
```



```{r, eval=FALSE}
# Simplify data.frame names

# pop_growth_df <-  API_SP.POP.GROW_DS2_en_csv_v2.csv
# rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_growth_meta <- Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv
# rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_growth_merged <- merge(pop_growth_df, subset(pop_growth_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")
# 
# pop_df <- API_SP.POP.TOTL_DS2_en_csv_v2.csv
# rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_meta <- Metadata_Country_API_SP.POP.TOTL_DS2_en_csv_v2.csv
# rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_merged <- merge(pop_df, subset(pop_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")
# 
# energy_df <- API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
# rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
# energy_df_meta <- Metadata_Country_API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
# # rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
# energy_merged <- merge(energy_df, subset(energy_df_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")
# 
# tidy_pop_energy <- rbind(pop_growth_merged, pop_merged, energy_merged)
# 
# tidy_pop_energy <- tidy_pop_energy %>% 
#     gather(key = "YEAR", value = "VALUE", -COUNTRY_CODE, -COUNTRY_NAME,
#            -INDICATOR_NAME, -INDICATOR_CODE, -REGION, -INCOMEGROUP) %>%
#     mutate(YEAR = as.numeric(YEAR)) %>%
#     mutate(VALUE = as.numeric(VALUE))
# 
# # Filter out rows where the country is not actually a country.
# 
# not_country = c("Arab World", "Central Europe and the Baltics", "Early-demographic dividend", "Europe & Central Asia (excluding high income)", "Euro area", "Fragile and conflict affected situations", "Heavily indebted poor countries (HIPC)", "IBRD only","IDA total", "Not classified", "Latin America & Caribbean (excluding high income)", "Latin America & Caribbean", "Low income", "Low & middle income", "Late-demographic dividend", "Middle income", "North America", "Post-demographic dividend", "Small states", "East Asia & Pacific (IDA & IBRD countries)", "Latin America & the Caribbean (IDA & IBRD countries)", "Middle East & North Africa (IDA & IBRD countries)", "South Asia (IDA & IBRD)", "World", "Upper middle income", "Sub-Saharan Africa (IDA & IBRD countries)", "Europe & Central Asia (IDA & IBRD countries)", "Sub-Saharan Africa", "Sub-Saharan Africa (excluding high income)", "Pacific island small states", "Pre-demographic dividend", "Other small states", "OECD members", "Middle East & North Africa (excluding high income)", "Middle East & North Africa", "Lower middle income", "Least developed countries: UN classification", "IDA only", "IDA blend", "IDA & IBRD total", "High income", "European Union", "Europe & Central Asia", "East Asia & Pacific", "East Asia & Pacific (excluding high income)", "Caribbean small states", "South Asia")
# 
# tidy_pop_energy <- filter(tidy_pop_energy, !COUNTRY_NAME %in% not_country)
# # Sort dataframe by country name
# tidy_pop_energy <- tidy_pop_energy %>% arrange(COUNTRY_NAME)
```





### Analysis of Data Quality

Provide a detailed, well-organized description of data quality, including textual description, graphs, and code.

* For some years, total production by region is much higher than %100

There is a lot of missing data before 1971 and after 2012.

- line graph with three lines one for each indicator. Y is percent of missing values. X axis is year.
- histogram of percent of missing data. Each datapoint is a country
- see what David wrote



The visna() graphs show the the population data is nearly complete, but the energy use data has a significant amount of missing data.

```{r Visna() Graphs}
# Convert tidy data to wide and segment by indicator to get a better picture of missing data
# patterns across time


wide_energy_low <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "Low income")
wide_energy_low <- select(wide_energy_low, YEAR, COUNTRY_CODE, VALUE)
wide_energy_low <- wide_energy_low %>% spread(YEAR, VALUE)

visna(wide_energy_low, sort = 'r')

wide_energy_low_mid <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "Lower middle income")
wide_energy_low_mid <- select(wide_energy_low_mid, YEAR, COUNTRY_CODE, VALUE)
wide_energy_low_mid <- wide_energy_low_mid %>% spread(YEAR, VALUE)

visna(wide_energy_low_mid, sort = 'r')

wide_energy_up_mid <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "Upper middle income")
wide_energy_up_mid <- select(wide_energy_up_mid, YEAR, COUNTRY_CODE, VALUE)
wide_energy_up_mid <- wide_energy_up_mid %>% spread(YEAR, VALUE)

visna(wide_energy_up_mid, sort = 'r')

wide_energy_up <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "High income")
wide_energy_up <- select(wide_energy_up, YEAR, COUNTRY_CODE, VALUE)
wide_energy_up <- wide_energy_up %>% spread(YEAR, VALUE)

visna(wide_energy_up, sort = 'r')

wide_pop_total <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Population, total")
wide_pop_total <- select(wide_pop_total, YEAR, COUNTRY_CODE, VALUE)
wide_pop_total <- wide_pop_total %>% spread(YEAR, VALUE)
visna(wide_pop_total, sort = 'r')

wide_pop_growth <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Population growth (annual %)")
wide_pop_growth <- select(wide_pop_growth, YEAR, COUNTRY_CODE, VALUE)
wide_pop_growth <- wide_pop_growth %>% spread(YEAR, VALUE)
visna(wide_pop_growth, sort = 'r')
```

To get a broad sense of the interaction between energy consumption and total population, we created new variable for the concatenation of country and year. This technique creates a unique identifier for each observation. It is difficult to see general patterns initially due to outliers, so we removed these in a second scatterplot.

```{r Scatter plot of energy use and growth rate by country-year}
# Scatter plot of energy use and growth rate by country-year


pop_country_year <- pop_df %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

energy_country_year <- energy_df %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

pop_country_year <- pop_country_year %>% mutate(POP_GROWTH_RATE = VALUE)
energy_country_year <- energy_country_year %>% mutate(ENERGY_USE = VALUE)

pop_energy_year <- 
    left_join(pop_country_year, energy_country_year, by = "COUNTRY_YEAR") %>%
    select(COUNTRY_YEAR, POP_GROWTH_RATE, ENERGY_USE) %>%
    filter(POP_GROWTH_RATE != '' & ENERGY_USE != '') %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
    mutate(ENERGY_USE = as.numeric(ENERGY_USE))

ggplot(pop_energy_year, aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point(alpha = .1) + geom_density_2d()

ggplot(pop_energy_year %>% filter(ENERGY_USE <= 10000 & POP_GROWTH_RATE <= 2e+07),
       aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point(alpha = .1) + geom_density_2d()




# Hard to tell what's going on without any subsetting.
# pop_elec_year <- 
#     left_join(pop_country_year, elec_access_country_year, by = "COUNTRY_YEAR") %>%
#     select(COUNTRY_YEAR, POP_GROWTH_RATE, ELECTRICITY_ACCESS) %>%
#     filter(POP_GROWTH_RATE != '' & ELECTRICITY_ACCESS != '') %>%
#     mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))

# ggplot(pop_elec_year, aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# ggplot(pop_elec_year %>% filter(POP_GROWTH_RATE >= 5), 
#        aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# Counts of countries by region and income group
#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(Region)) +
 #   geom_bar() + coord_flip()

#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(IncomeGroup)) +
 #   geom_bar() + coord_flip()




```

Discuss how data is limited to after 1960, and even then for "Energy Use" it's only a small portion of countries are represented in the earlier years, specifically high income countries. This limits inferences we can make about lower income countries in that decade, or long term inference across the whole of the 20th century. This could be displayed as table or bar chart of total count of nations per year in the three data sets. Maybe see if there are geographic/income-based patterns across the data, which would bias the results.

Talk about how in the meta files, there is a Special Notes column for descriptions on how the data was modified or revised. This might indicate the data isn't entirely accurate.

We explored using additional data from the World Bank, namely energy consumption by type as a percentage of total energy consumption. These data show what percentage of energy consumption is from nuclear, non-nuclear renewables, oil, natural gas, and coal. The data take the same format as the data we did use in this project. The initial intention behind using these consumption percentage data was to see if there are any connections between population growth, total energy use, and consumption habits. For example, one hypothethical correlation might be between quickly growing populations and heavy reliance on coal. However, we ultimately decided against using the consumption data in our final analysis.
    
### Main Analysis (Exploratory Data Analysis)

The main analysis section has been split into the following subsecitons.
  1. **Overview** - High level representaiton of the relaitonship between energy and population over time.
  2. **Interactive component** - Tools for observing numerous facets of the data.
  3. **Findings** - Key insights and challanges the team faced. 

#### Overview
As shown in Figure 1-4, energy use is consistently growing. As today the The International Energy Angency reports  that 13.2% of energy in the world comes from renewable sources. (https://www.iea.org/about/faqs/renewableenergy/). Therefore, to replace our energy consumption with 100% clean, renewable source we need to increase our current capacity by 7.5 times. However, we learn from Figure 1-4 that energy consumption has growth approximitely 2.5 times from 1975 to 2010 at a growth rate of 2.6%. If the growth rate stayed the same the energy use in 2100 would be over 8 times what it is today. Thefore, to go 100% clean energy by 2100 would require increasing clean energy capcity by 64 times. 

```{r echo = FALSE}
# Reform data
icodes <-  unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 100
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Alter dataset
icodes <- unique(tidy_pop_energy$INDICATOR_CODE)
my_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[2],]
my_data$VALUE <- as.numeric(my_data$VALUE)/1000000
my_data$YEAR <- as.numeric(my_data$YEAR)

# ENERGY GROWTH
energy_agg <- aggregate(energy_tot ~ YEAR, scatter_data, sum)
ggplot(energy_agg, aes(YEAR, energy_tot)) + geom_line() +
  labs(title="Figure 4-1. Energy Growth", 
       x="YEAR", 
       y="Energy use (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010))

```

Therefore, for society to go 100% clean energy we need to slow our energy growth as well. One approach to slowing energy growth is to slow population as well. Figure 4-2 shows that population also consistently growing, while energy use per-capita (Figure 4-3) has only shown moderate growth. The slow growth of energy per-captia shows that our improvements in energy efficiency are keeping up with our demand for more power. Hence, if we could just stop population growth we stop energy growth. 

```{r echo = FALSE}
# POPULATION GROWTH
pop_agg <- aggregate(pop_tot ~ YEAR, scatter_data, sum)
ggplot(pop_agg, aes(YEAR, pop_tot)) + geom_line() +
  labs(title="Population Growth", 
       x="YEAR", 
       y="Population (millions)") +
  coord_cartesian(xlim=c(1975, 2010))

# Per capita
energy_capita_agg <- aggregate(energy_percap ~ YEAR, scatter_data, mean)
energy_capita_agg$weighted <- energy_agg$energy_tot / pop_agg$pop_tot
ggplot(energy_capita_agg, aes(YEAR, weighted)) + geom_line() +
  labs(title="Energy per Capita", 
       x="YEAR", 
       y="Energy use per capita (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010))
```

Yet when we look at figures such as 3-# and 3-# (the scatter plot in data quality section) we learn that when we split by country the smooth coorelation immediately goes away. In the remainder of the main analysis we provide interactive tools explore the relationship between energy growth and populaiton, and then present our main findings from using the tools we made.

#### Interactive component
As we started to determine what graphs we should shown in this analysis, we quickly realized there were so many insightful ways we could split the data the report would either be too long or skipping key insights. Therefore, we chose to do interactive R Shiny apps for the main part of our analysis. This allowed our team to easily explore the data, while also allowing users to explore in ways we had not yet thought of. 


We broke the data into there separate apps to explore these distinct aspects of the data. The three apps are listed below.

1. One country at a time....
  - Dropdown to select country
  - Shows graph of population, population growth, energy and energy growth over time
  - Dropdown for line graph or histogram
  
2. Distribution of population and energy across the world (David)
  - Each bar represents the value per country
  - Value select (population or energy use)
  - Slider bar on bottom for year

The third graph we were inspired by a TED talk.
3. Scatter to compare energy and population growth rates (Isaac)
  - Each point is a country
  - Slider bar on bottom for year
  - X is energy growth rate
  - Y is population growth rate
  - Size of circle is size of population

```{r NavBar}
navbarPage("Good Graphics",
           tabPanel("Macroview",
                    sidebarLayout(
                        mainPanel(
                          plotOutput("countryhist")
                          ),
                        sidebarPanel(
                          selectInput(inputId = "tab1country", label = "Country:",
                                      choices = as.vector(unique(tidy_pop_energy$COUNTRY_NAME)), 
                                      selected = as.vector(unique(tidy_pop_energy$COUNTRY_NAME))[1])
                        )
                    )
                )
           ,
           tabPanel("TEST",
                    sidebarLayout(
                        sidebarPanel(
                            selectInput("n_breaks", label = "Number of bins:",
                                        choices = c(10, 20, 35, 50), selected = 20),
                            sliderInput("bw_adjust", label = "Bandwidth adjustment:",
                                        min = 0.2, max = 2, value = 1, step = 0.2)
                            ),
                        mainPanel(
                            plotOutput("hist")
                            )
                        )
                    )
           ,
           tabPanel("Distribution of Population and Energy",
                    
                        verticalLayout(
                            plotOutput("ds_barplot", width = "100%"),
                            fluidRow(
                                column(
                            radioButtons(label = "Indicator", inputId = "indicator",
                                         choices = c("Population Growth" = "Population growth (annual %)",
                                                     "Energy Use" = "Energy use (kg of oil equivalent per capita)",
                                                     "Total Population" = "Population, total"),
                                         selected = "Population growth (annual %)"), width = 3),
                            column(
                            radioButtons(label = "Categories", inputId = "category",
                                         choices = c("Geographic Region" = "REGION",
                                                     "Income Group" = "INCOMEGROUP",
                                                     "None" = "INDICATOR_NAME"),
                                         selected = "INDICATOR_NAME"), width = 3),
                            column(
                            sliderInput(inputId = "year",
                                        label = "Year:", 
                                        value = 1961,
                                        min = 1961,
                                        animate = animationOptions(interval = 333),
                                        max = 2016,
                                        step = 1), width = 3),
                            
                                  # Copy the line below to make a slider range 
                            column(
                              sliderInput(inputId = "rank_slider", 
                                          label = "Percentage slice", 
                                          min = 0, max = 1, value = c(0, 1)),width = 3)
                            )
                        )
                    )
           ,
           tabPanel("Growth Rate Scatter",
                      verticalLayout(
                        plotOutput("ds_scatter",  width = "100%"),
                        wellPanel(
                          sliderInput(inputId = "year_scatter",
                                      label = "Year:", 
                                      value = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                      min = 1971,
                                      max = 2012,
                                      step = 1),
                          sliderInput(inputId = "pop_max",
                                      label = "Max population:", 
                                      value = 1500,
                                      min = 0,
                                      max = 1500,
                                      step = 100),
                          sliderInput(inputId = "energy_max",
                                      label = "Max energy:", 
                                      value = 30000,
                                      min = 0,
                                      max = 30000,
                                      step = 2000)
                        )
                      )
           )
)
  #   tabPanel("Distribution of Population and Energy",
  #       sidebarLayout(
  #           sidebarPanel(
  #               selectInput("region", "Region:",
  #                           choices=colnames(WorldPhones)),
  #     hr(),
  #     helpText("Data from AT&T (1961) The World's Telephones.")
  #   ),
  #   
  #   # Create a spot for the barplot
  #   mainPanel(
  #     plotOutput("ds_barplot")  
  #   )
  #   
  # )
  #            
  # )

```






```{r Test Tab}
output$hist <- renderPlot({
  hist(faithful$eruptions, probability = TRUE, 
       breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", 
       main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```

```{r Bar Plot tab}
# Render a barplot

my_indicator <- reactive({input$indicator})
my_year <- reactive({input$year})
fill_selection <- reactive({input$category})

rank_range <- reactive({input$rank_slider})

bar_colors <- c(`East Asia & Pacific` = "#F8766D",
                `Latin America & Caribbean` = "#C49A00",
                `North America` = "#53B400",
                `Sub-Saharan Africa` = "#00C094",
                `Europe & Central Asia` = "#00B6EB",
                `Middle East & North Africa` = "#A58AFF",
                `South Asia` = "#FB61D7",
                `High income` = "#238b45",
                `Upper middle income` = "#66c2a4",
                `Lower middle income` = "#b2e2e2",
                `Low income` = "#edf8fb",
                `Population growth (annual %)` = "#999999",
                `Energy use (kg of oil equivalent per capita)` = "#999999", 
                `Population, total` = "#999999")



tidy_subset_barplot <- reactive({tidy_pop_energy %>%
        filter(INDICATOR_NAME == my_indicator() & YEAR == my_year()) %>%
        na.omit() %>%
        arrange(VALUE) %>%
        mutate(INCOMEGROUP = factor(INCOMEGROUP, levels = c("High income", "Upper middle income", 
                                                            "Lower middle income", "Low income"))) %>%
        mutate(value_percent_rank = percent_rank(VALUE)) %>%
        mutate(value_percent_rank = value_percent_rank - .0000001) %>%
        filter(value_percent_rank >= rank_range()[1] & value_percent_rank <= rank_range()[2])

})
# total_countries <- reactive({length(unique(tidy_subset_barplot$COUNTRY_CODE))})

output$ds_barplot <- renderPlot({
    ggplot(data = tidy_subset_barplot(), 
           aes(x = reorder(COUNTRY_CODE, VALUE), y = VALUE,
               fill = get(fill_selection()))) +
        geom_col() + xlab("Country") + ylab(my_indicator()) +
          scale_fill_manual(values = bar_colors, name = "Categories")

})


```

```{r Scatter Plot tab}
# Growth rate scatter


#TODOs
# Larger fonts
# Play button
# Button zoom in and out instead of slider.


# Reform data
icodes = unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 100
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Most energy using countries 
energy2012 <- scatter_data$energy_tot[scatter_data$YEAR == "2012"]
energy2012[is.na(energy2012)] <- 0
energy2012_total <- sum(energy2012)
sum(sort(energy2012, decreasing=TRUE)[0:5])/energy2012_total # top 20

# Config sliders
year_scatter <- reactive({input$year_scatter})
pop_max <- reactive({input$pop_max})
energy_max <- reactive({input$energy_max})

# Config data
tidy_subset <- reactive({scatter_data %>%
    filter(YEAR == year_scatter())
})

# Make plot
output$ds_scatter <- renderPlot({
    ggplot(data = tidy_subset(), aes(x=pop_tot, y=energy_tot, col=REGION)) +
        geom_point(size=5) + labs(title="Population vs. Energy Use", 
                            x="Population (millions)", 
                            y="Energy use (teragrams of oil equivelent)") + 
        coord_cartesian(xlim=c(0, pop_max()), ylim=c(0, energy_max())) +
        scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
        geom_text(aes(label=COUNTRY_NAME),hjust=-0.2, vjust=0)
}) 

#ggplot(scatter_data, aes(pop_growth, energy_tot)) + geom_point(size=scatter_data$pop_tot) + labs(title="Population Growth vs. Energy Use")

```

```{r Tab 1}
# Tab1 Code

#create the dropdown 
tab1_countries <- reactive({input$tab1country})

# Population Total
tab1_total <- tidy_pop_energy %>% 
    filter(tidy_pop_energy$INDICATOR_NAME != "Population growth (annual %)") 
tab1_total_reactive <- reactive({filter(tab1_total, tab1_total$COUNTRY_NAME == tab1_countries())})

# render graph
output$countryhist <- renderPlot({
    ggplot(data=tab1_total_reactive(), aes(x=YEAR, y=VALUE)) + 
    geom_point() + geom_line() +
    facet_wrap(~INDICATOR_NAME, ncol=1, scale="free") +
    labs(title="Total Population over Time", x="Year")
})
```

```{r}
#CODE TRYING TO DEBUG FACET WRAP
usa_energy <- tidy_pop_energy %>% 
    filter(tidy_pop_energy$INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)", tidy_pop_energy$COUNTRY_NAME == "United States")
usa_pop <- tidy_pop_energy %>%
  filter(tidy_pop_energy$INDICATOR_NAME == "Population, total", tidy_pop_energy$COUNTRY_NAME == "United States")

usa_data <- tidy_pop_energy %>% filter(tidy_pop_energy$INDICATOR_NAME != "Population growth (annual %)", tidy_pop_energy$COUNTRY_NAME == "United States")

ggplot(data=usa_data, aes(x=YEAR, y=VALUE)) + geom_point() + facet_wrap(~usa_data$INDICATOR_CODE, ncol=1, scale="free")

# usa_total <- tab1_total %>% filter(tab1_total$COUNTRY_NAME == "United States", )

#ggplot(data=usa_total, aes(x=usa_total$YEAR, y=usa_total$VALUE)) +
#  facet_wrap(~usa_total$INDICATOR_NAME, scales="free") + geom_line() + geom_point()
```

#### Findings




Overall distribution of population and energy. 

#### No visible correlation
When broken down by country there is not a solid correlation between population and energy. 
	       	
Show your scatter plot zoomed and not zoomed
	       	
	       	
#### Different paths to high energy use
There are two paths to very high energy growth. One is Done by the US Where energy per capita is high but population does not grow. The second is by china where the population grows considerable and then per capita energy growth goes up. We can see this trend starting with other countries. For example, Egypt population is growing yet the energy growth is not drastically growing. This begs the question, what changed for china to slow down its population growth and change to energy growth?

#### Some countries didn't grow
There are also examples, such as Germany, where over the whole range there is little change in population and energy use. Needless the country has certainly had advances in health, technology, education, any more. Which leads to the question, what makes that country different from the rest?

#### Outliers
Three countries stand out from the rest. Why do these countries need to be different? Also over the 40 year span these countries are still the only ones separate. This leads me to believe that compounding (potentially capitalism) has influence.

 


```{r Who are the big players?}
# Who are the big players?
# Histogram of population in latest year. Group all coutnries after top 100. Could also present in mosiac plot.
# energy_2010 <- energy_country_year[energy_country_year$YEAR == "2010", ]
# # energy_2010$ENERGY_USE=as.numeric(energy_2010$ENERGY_USE)
# energy_2010$ENERGY_USE=as.numeric(energy_2010$VALUE)
# energy_2010$YEAR=as.numeric(energy_2010$YEAR)
# energy_2010 <- energy_2010[with(energy_2010, order(energy_2010$ENERGY_USE)),]
# 
# ggplot(energy_2010, aes(x=COUNTRY_CODE, y=ENERGY_USE)) + geom_bar(stat='sum') + 
#     labs(title="Population by Country", x="Country", y="Energy use (Btu?)")


# Histogram of energy in latest year.

# Repeat two above with mosaic plot

```

- Binned Histogram of 
  - Energy use and energy use per capita for latest year
  - Population and population growth rate for latest year
  - Population and energy growth rate across years for select countries
  


#### Take whats needed from below and then delete.
  


```{r Population growth rate over time by geographic region}
# Population growth rate over time by geographic region
pop_year_world <- pop_country_year %>%
    filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS")) %>%
    mutate(YEAR = as.integer(YEAR)) %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE))



ggplot(pop_year_world, 
       aes(YEAR, POP_GROWTH_RATE, color = COUNTRY_CODE)) + geom_line()

# elec_access_year_world <- elec_access_country_year %>%
#     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS")) %>%
#     mutate(YEAR = as.integer(YEAR)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))


# No recorded values before 1990
# ggplot(elec_access_year_world %>% filter(YEAR >= 1990), 
#        aes(YEAR, ELECTRICITY_ACCESS, color = COUNTRY_CODE)) + geom_line()
```


```{r}

# world_prod_coal <- elec_prod_coal %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_hydro <- elec_prod_hydro %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_natural_gas <- elec_prod_natural_gas %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_nuclear <- elec_prod_nuclear %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_oil <- elec_prod_oil %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_renewable <- elec_prod_renewable %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# 
# world_prod_total <- rbind(world_prod_coal, world_prod_hydro, 
#                           world_prod_natural_gas, world_prod_nuclear,
#                           world_prod_oil, world_prod_renewable)
# 
# world_prod_total <- world_prod_total %>%
#      gather(key = "YEAR", value = "VALUE", -COUNTRY_NAME, -COUNTRY_CODE,
#             -INDICATOR_NAME, -INDICATOR_CODE) %>%
#      mutate(VALUE = as.numeric(VALUE)) %>%
#      mutate(YEAR = as.integer(YEAR)) %>%
#      left_join(y = pop_meta) %>%
#      drop_na()

# world_prod_total <- na.rm(world_prod_total)


# ggplot(world_prod_total %>% filter(COUNTRY_CODE == "WLD"),
#        aes(YEAR, VALUE, color = INDICATOR_CODE)) +
#      geom_line()
# 
# ggplot(world_prod_total,
#        aes(YEAR, VALUE, color = INDICATOR_CODE)) +
#      geom_line() + facet_wrap(facets = "COUNTRY_NAME")


# Data issue - for some years, total production by region is way above %100
# world_prod_total %>% 
#      group_by(COUNTRY_CODE, YEAR) %>% 
#      summarize(total = sum(VALUE)) %>%
#      arrange(-total)

```




### Executive Summary (Presentation-style)

Note: "Presentation" here refers to the style of graph, that is, graphs that are cleaned up for presentation, as opposed to the rough ones we often use for exploratory data analysis. You do not have to present your work to the class! However, you may choose to present your work as your community contribution, in which case you need to email me to set a date before the community contribution due date (Apr 3). (The presentation itself may be later.)

Provide a short nontechnical summary of the most revealing findings of your analysis  written for a nontechnical audience. The length should be approximately two pages (if we were using pages...) Take extra care to clean up your graphs, ensuring that best practices for presentation are followed.




### Conclusion

Discuss limitations and future directions, lessons learned.

#### Key findings
List our most insightful findings

#### Future work
There are certainly other factors in the relationship between population and energy use. These include economic, health, wealth, and many more. Including these factors in future analyses would be beneficial.

Our group sees this tidy dataframe as a product in itself. Talk about file size and how it organizes code and fits good in memory and simply provides the necessary work to analyze this. A good idea would be to make this into an r package. 

Create r package with dataset for others to contribute

Create open source avenue for collaborators to share their explorations of the data.

Future work could include additional metadata to further explore the relationship betweeen energy and population. For example economic indicators such as GDP, income and wealth. Health indicators such as life expectancy and birthrate. And finally energy sources such as solar, wind, coal, oil and end uses such as trasportation, residential, commercial, and industrial.

