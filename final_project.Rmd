---
title: "Final Project"
author: "Names and Unis....."
date:   "April 24, 2018"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
                      message = FALSE)
```


### Introduction

The goal of our project is to explore the relationship between the world's energy consumption and population over time. Specifically, we are interested in exploring the interaction between these variables over time at a global, regional, and country level in order to making inferences about any correlation between these variables, so as to better understand the future. 

Our team includes:
* David Schemitsch
* Isaac Wainstein
* Wyatt Ford

### Description of Data

Our project uses three datasets published by the World Bank:

* Population, total
* Population growth (annual %)
* Energy use (kg of oil equivalent per capita)

Each of these datasets contain per country data from 1960 through 2016. The data was gathered and accessed using the World Bank's api, cleaned, and combined into one tidy dataframe.

tidy data is a product in itself. Talk sboutfile size and how it organizes code and fits good in memory and simply provides the necessary work to analyze this. A good idea would be to make this into an r package. 

```{r}
# Install and/or load required libraries
needed_packages <- c("data.table", "tidyverse")

for (p in needed_packages) {
     if (!(p %in% installed.packages())){
          install.packages(p)
     }
}

library(data.table)
library(tidyverse)
```

```{r, results = "hide"}

### Download, unzip, and read in data stored as CSV files

#TODO Tidy the data

# Links for data sources
pop_growth_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.GROW?downloadformat=csv"
pop_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.TOTL?downloadformat=csv"
energy_zip <- "http://api.worldbank.org/v2/en/indicator/EG.USE.PCAP.KG.OE?downloadformat=csv"

# Download and unzip data sources
zip_list <- c(pop_growth_zip, pop_zip, energy_zip)

for (i in zip_list){
    
    td = tempdir()
    tf = tempfile(tmpdir=td, fileext=".zip")
    
    download.file(i, tf, mode = "wb")
    zip_folder <- unzip(tf, list = TRUE)
    
    for (j in seq_along(zip_folder$Name)) {
        
        file_name = unzip(tf, list = TRUE)$Name[j]
        unzip(tf, files = file_name, exdir = td, overwrite = TRUE)
        file_path <- file.path(td, file_name)
        csv <- fread(file_path)
        new_header <- str_to_upper(gsub(pattern = " ", replacement = "_", x = names(csv)))
        setnames(csv, new_header)
        assign(file_name, csv)
        
    }
    
}
```

```{r}
# Simplify data.frame names

pop_growth_df <-  API_SP.POP.GROW_DS2_en_csv_v2.csv
rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_growth_meta <- Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv
rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_growth_merged <- merge(pop_growth_df, subset(pop_growth_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")

pop_df <- API_SP.POP.TOTL_DS2_en_csv_v2.csv
rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_meta <- Metadata_Country_API_SP.POP.TOTL_DS2_en_csv_v2.csv
rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_merged <- merge(pop_df, subset(pop_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")

energy_df <- API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
energy_df_meta <- Metadata_Country_API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
# rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
energy_merged <- merge(energy_df, subset(energy_df_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")

tidy_pop_energy <- rbind(pop_growth_merged, pop_merged, energy_merged)

tidy_pop_energy <- tidy_pop_energy %>% 
    gather(key = "YEAR", value = "VALUE", -COUNTRY_CODE, -COUNTRY_NAME,
           -INDICATOR_NAME, -INDICATOR_CODE, -REGION, -INCOMEGROUP) %>%
    mutate(YEAR = as.numeric(YEAR)) %>%
    mutate(VALUE = as.numeric(VALUE))

# Filter out rows where the country is not actually a country.

not_country = c("Arab World", "Central Europe and the Baltics", "Early-demographic dividend", "Europe & Central Asia (excluding high income)", "Euro area", "Fragile and conflict affected situations", "Heavily indebted poor countries (HIPC)", "IBRD only","IDA total", "Not classified", "Latin America & Caribbean (excluding high income)", "Latin America & Caribbean", "Low income", "Low & middle income", "Late-demographic dividend", "Middle income", "North America", "Post-demographic dividend", "Small states", "East Asia & Pacific (IDA & IBRD countries)", "Latin America & the Caribbean (IDA & IBRD countries)", "Middle East & North Africa (IDA & IBRD countries)", "South Asia (IDA & IBRD)", "World", "Upper middle income", "Sub-Saharan Africa (IDA & IBRD countries)", "Europe & Central Asia (IDA & IBRD countries)", "Sub-Saharan Africa", "Sub-Saharan Africa (excluding high income)", "Pacific island small states", "Pre-demographic dividend", "Other small states", "OECD members", "Middle East & North Africa (excluding high income)", "Middle East & North Africa", "Lower middle income", "Least developed countries: UN classification", "IDA only", "IDA blend", "IDA & IBRD total", "High income", "European Union", "Europe & Central Asia", "East Asia & Pacific", "East Asia & Pacific (excluding high income)", "Caribbean small states", "South Asia")

tidy_pop_energy <- filter(tidy_pop_energy, !COUNTRY_NAME %in% not_country)
```

```{r}
pop_meta <- pop_meta[, .(COUNTRY_CODE, REGION, INCOMEGROUP)]

pop_df <- pop_df[,!"V63"]


pop_country_year <- pop_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "POP_GROWTH_RATE", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

energy_country_year <- energy_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "ENERGY_USE", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))
```

### Analysis of Data Quality

Provide a detailed, well-organized description of data quality, including textual description, graphs, and code.

* For some years, total production by region is much higher than %100

There is a lot of msising data before 1971 and after 2012.

### Main Analysis (Exploratory Data Analysis)

Provide a detailed, well-organized description of your findings, including textual description, graphs, and code.  Your focus should be on both the results and the process. Include, as reasonable and relevant, approaches that didn't work, challenges, the data cleaning process, etc.


#### Latest
- Hypothesis. Explore how relationship and energy and pop;ation has changed over time to make inferences about why this happened and what may happen in the future.

Three rshiny tabs 1 per person

1. One country at a time (Wyatt)
  - Dropdown to select country
  - Shows graph of population, population growth, energy and energy growth over time
  - Dropdown for line graph or histogram
  
2. Distribution of population and energy across the world (David)
  - Each bar represents the value per country
  - Value select (population or energy use)
  - Slider bar on bottom for year

3. Scatter to compare energy and population growth rates (Isaac)
  - Each point is a country
  - Slider bar on bottom for year
  - X is energy growth rate
  - Y is population growth rate
  - Size of circle is size of population

```{r}
navbarPage("Good Graphics",
           tabPanel("Macroview",
                    sidebarLayout(
                        sidebarPanel(
                          selectInput("n_breaks", label = "Country:",
                                      choices = tidy_pop_energy$COUNTRY_NAME, selected = "Aruba")
                        ),
                    mainPanel(
                      plotOutput("countryhist")
                      )
                    )
           )
           ,
           tabPanel("TEST",
                    sidebarLayout(
                        sidebarPanel(
                            selectInput("n_breaks", label = "Number of bins:",
                                        choices = c(10, 20, 35, 50), selected = 20),
                            sliderInput("bw_adjust", label = "Bandwidth adjustment:",
                                        min = 0.2, max = 2, value = 1, step = 0.2)
                            ),
                        mainPanel(
                            plotOutput("hist")
                            )
                        )
                    )
           ,
           tabPanel("Distribution of Population and Energy",
                    sidebarLayout(
                        sidebarPanel(
                            radioButtons(label = "Indicator", inputId = "indicator",
                                         choices = c("Population Growth" = "Population growth (annual %)",
                                                     "Energy Use" = "Energy use (kg of oil equivalent per capita)",
                                                     "Total Population" = "Population, total"),
                                         selected = "Population growth (annual %)"),
                             # c("Population Growth" = "Population growth (annual %)",
                             #   "Energy Use" = "Energy use (kg of oil equivalent per capita)",
                             #   "Total Population" = "Population, total")),
                            sliderInput(inputId = "year",
                                        label = "Year:", 
                                        value = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                        min = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                        max = max(tidy_pop_energy$YEAR, na.rm = TRUE),
                                        step = 1)
                            ),
                        mainPanel(
                            plotOutput("ds_barplot")
                            )
                        )
                    )
           ,
           tabPanel("Growth Rate Scatter",
                      verticalLayout(
                        plotOutput("ds_scatter",  width = "100%"),
                        wellPanel(
                          sliderInput(inputId = "year_scatter",
                                      label = "Year:", 
                                      value = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                      min = 1971,
                                      max = 2012,
                                      step = 1),
                          sliderInput(inputId = "pop_max",
                                      label = "Max population:", 
                                      value = 1500,
                                      min = 0,
                                      max = 1500,
                                      step = 100),
                          sliderInput(inputId = "energy_max",
                                      label = "Max energy:", 
                                      value = 30000,
                                      min = 0,
                                      max = 30000,
                                      step = 2000)
                        )
                      )
           )
)
  #   tabPanel("Distribution of Population and Energy",
  #       sidebarLayout(
  #           sidebarPanel(
  #               selectInput("region", "Region:",
  #                           choices=colnames(WorldPhones)),
  #     hr(),
  #     helpText("Data from AT&T (1961) The World's Telephones.")
  #   ),
  #   
  #   # Create a spot for the barplot
  #   mainPanel(
  #     plotOutput("ds_barplot")  
  #   )
  #   
  # )
  #            
  # )

```



### ...that build a histogram.
```{r}
# U.S.A.!
pop_growth <- filter(tidy_pop_energy, tidy_pop_energy$INDICATOR_NAME == "Population growth (annual %)")
usa_growth <- filter(pop_growth, pop_growth$COUNTRY_NAME == "United States")
ggplot(data=usa_growth, aes(x=usa_growth$YEAR, y=usa_growth$VALUE)) +
  geom_line() +
  geom_point()

output$countryhist <- renderPlot({
    ggplot(data=pop_growth, aes(x=pop_growth$YEAR, y=pop_growth$VALUE)) +
        geom_line() +
        geom_point()
})
```


```{r echo = FALSE}
output$hist <- renderPlot({
  hist(faithful$eruptions, probability = TRUE, 
       breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", 
       main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```

```{r}
# Render a barplot

my_indicator <- reactive({input$indicator})
my_year <- reactive({input$year})


tidy_subset <- reactive({tidy_pop_energy %>%
    filter(INDICATOR_NAME == my_indicator() & YEAR == my_year())
})

output$ds_barplot <- renderPlot({
    ggplot(data = tidy_subset(), aes(COUNTRY_CODE, VALUE)) +
        geom_col()
})

# output$ds_barplot <- renderPlot({
#     
#     barplot(tidy_pop_energy %>%
#                 filter(INDICATOR_NAME == input$indicator & YEAR == input$year) %>%
#                 select(COUNTRY_NAME, YEAR, VALUE), 
#             main=input$value,
#             ylab="Number of Telephones",
#             xlab="Year")
# })

# output$phonePlot <- renderPlot({
#     
# # Render a barplot
#     barplot(WorldPhones[,input$region]*1000, 
#             main=input$region,
#             ylab="Number of Telephones",
#             xlab="Year")
# })
    
# tidy_pop_energy %>%
#     filter(INDICATOR_NAME == "Population growth (annual %)") %>%
#     select(COUNTRY_NAME, YEAR, VALUE)
# 
# tidy_pop_energy %>%
#     filter(INDICATOR_NAME == input$indicator & YEAR == input$year) %>%
#     select(COUNTRY_NAME, YEAR, VALUE)




```

```{r}
# Growth rate scatter


#TODOs
# Tool tip for country Name.
# Add filter for max axis ranges so you can zoom in


# Findings
# There are two paths to very high energy growth. One is Done by the US Where energy per capita is high but population does not grow. The second is by china where the population grows considerable and then per capita energy growth goes up. THe vast majority of countries has smaller popualtion.

# There are also examples, such as Germany, where over the whole range there is little change in population and energy use. Needless the country has certianly had advances in health, technology, education, andmore. WHich leads to the quesiton, what makes that country different from the rest?

# Reform data
icodes = unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 100
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Most energy using countries 
energy2012 <- scatter_data$energy_tot[scatter_data$YEAR == "2012"]
energy2012[is.na(energy2012)] <- 0
energy2012_total <- sum(energy2012)
sum(sort(energy2012, decreasing=TRUE)[0:5])/energy2012_total # top 20

# Config sliders
year_scatter <- reactive({input$year_scatter})
pop_max <- reactive({input$pop_max})
energy_max <- reactive({input$energy_max})

# Config data
tidy_subset <- reactive({scatter_data %>%
    filter(YEAR == year_scatter())
})

# Make plot
output$ds_scatter <- renderPlot({
    ggplot(data = tidy_subset(), aes(x=pop_tot, y=energy_tot, col=REGION)) +
        geom_point(size=5) + labs(title="Population vs. Energy Use", 
                            x="Population (millions)", 
                            y="Energy use (teragrams of oil equivelent)") + 
        coord_cartesian(xlim=c(0, pop_max()), ylim=c(0, energy_max())) +
        scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
        geom_text(aes(label=COUNTRY_NAME),hjust=-0.2, vjust=0)
}) 

#ggplot(scatter_data, aes(pop_growth, energy_tot)) + geom_point(size=scatter_data$pop_tot) + labs(title="Population Growth vs. Energy Use")

```

#### Distribution
Overall distribution of population and energy. 


```{r}
# Who are the big players?
# Histogram of population in latest year. Group all coutnries after top 100. Could also present in mosiac plot.
energy_2010=energy_country_year[energy_country_year$YEAR == "2010", ]
energy_2010$ENERGY_USE=as.numeric(energy_2010$ENERGY_USE)
energy_2010$YEAR=as.numeric(energy_2010$YEAR)
energy_2010 <- energy_2010[with(energy_2010, order(energy_2010$ENERGY_USE)),]

ggplot(energy_2010, aes(x=COUNTRY_CODE, y=ENERGY_USE)) + geom_bar(stat='sum') + labs(title="Population by Country", x="Country", y="Energy use (Btu?)")


# Histogram of energy in latest year.

# Repeat two above with mosaic plot

```

- Binned Histogram of 
  - Energy use and energy use per capita for latest year
  - Population and population growth rate for latest year
  - Population and energy growth rate across years for select countries
  


#### Is there a relationship?
- Scatter of energy per capita vs population pet capita
- scatter population total vs energy total
- Energy per capita vs population
- Could add diagonal line for all above
- alluvial diagram staring with total population and going to energy.
- Population growth rate on y axis and energy use per capita on x axis. The size of the population is the size of the circle on the graph
- Alpha bending and contour lines



#### Trends over time
- X axis is year. Y axis is energy use. Line thickness is population.
- Use D3 to animate how trends change over time. Essentially show the same graph but iterate over the year. Could do something similar to ted talk. Population growth rate on y axis and energy use per capita on x axis. The size of the population is the size of the circle on the graph

  
```{r}
# Scatter plot of energy use and growth rate by country-year
pop_energy_year <- 
    left_join(pop_country_year, energy_country_year, by = "COUNTRY_YEAR") %>%
    select(COUNTRY_YEAR, POP_GROWTH_RATE, ENERGY_USE) %>%
    filter(POP_GROWTH_RATE != '' & ENERGY_USE != '') %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
    mutate(ENERGY_USE = as.numeric(ENERGY_USE))

ggplot(pop_energy_year, aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point()


# Hard to tell what's going on without any subsetting.
# pop_elec_year <- 
#     left_join(pop_country_year, elec_access_country_year, by = "COUNTRY_YEAR") %>%
#     select(COUNTRY_YEAR, POP_GROWTH_RATE, ELECTRICITY_ACCESS) %>%
#     filter(POP_GROWTH_RATE != '' & ELECTRICITY_ACCESS != '') %>%
#     mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))

# ggplot(pop_elec_year, aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# ggplot(pop_elec_year %>% filter(POP_GROWTH_RATE >= 5), 
#        aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# Counts of countries by region and income group
#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(Region)) +
 #   geom_bar() + coord_flip()

#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(IncomeGroup)) +
 #   geom_bar() + coord_flip()


# Population growth rate over time by geographic region
pop_year_world <- pop_country_year %>%
    filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS")) %>%
    mutate(YEAR = as.integer(YEAR)) %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE))



ggplot(pop_year_world, 
       aes(YEAR, POP_GROWTH_RATE, color = COUNTRY_CODE)) + geom_line()

# elec_access_year_world <- elec_access_country_year %>%
#     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS")) %>%
#     mutate(YEAR = as.integer(YEAR)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))


# No recorded values before 1990
# ggplot(elec_access_year_world %>% filter(YEAR >= 1990), 
#        aes(YEAR, ELECTRICITY_ACCESS, color = COUNTRY_CODE)) + geom_line()

```



```{r}

# world_prod_coal <- elec_prod_coal %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_hydro <- elec_prod_hydro %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_natural_gas <- elec_prod_natural_gas %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_nuclear <- elec_prod_nuclear %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_oil <- elec_prod_oil %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_renewable <- elec_prod_renewable %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# 
# world_prod_total <- rbind(world_prod_coal, world_prod_hydro, 
#                           world_prod_natural_gas, world_prod_nuclear,
#                           world_prod_oil, world_prod_renewable)
# 
# world_prod_total <- world_prod_total %>%
#      gather(key = "YEAR", value = "VALUE", -COUNTRY_NAME, -COUNTRY_CODE,
#             -INDICATOR_NAME, -INDICATOR_CODE) %>%
#      mutate(VALUE = as.numeric(VALUE)) %>%
#      mutate(YEAR = as.integer(YEAR)) %>%
#      left_join(y = pop_meta) %>%
#      drop_na()

# world_prod_total <- na.rm(world_prod_total)


# ggplot(world_prod_total %>% filter(COUNTRY_CODE == "WLD"),
#        aes(YEAR, VALUE, color = INDICATOR_CODE)) +
#      geom_line()
# 
# ggplot(world_prod_total,
#        aes(YEAR, VALUE, color = INDICATOR_CODE)) +
#      geom_line() + facet_wrap(facets = "COUNTRY_NAME")


# Data issue - for some years, total production by region is way above %100
# world_prod_total %>% 
#      group_by(COUNTRY_CODE, YEAR) %>% 
#      summarize(total = sum(VALUE)) %>%
#      arrange(-total)

```




### Executive Summary (Presentation-style)

Note: "Presentation" here refers to the style of graph, that is, graphs that are cleaned up for presentation, as opposed to the rough ones we often use for exploratory data analysis. You do not have to present your work to the class! However, you may choose to present your work as your community contribution, in which case you need to email me to set a date before the community contribution due date (Apr 3). (The presentation itself may be later.)

Provide a short nontechnical summary of the most revealing findings of your analysis  written for a nontechnical audience. The length should be approximately two pages (if we were using pages...) Take extra care to clean up your graphs, ensuring that best practices for presentation are followed.

 

### Conclusion

Discuss limitations and future directions, lessons learned.