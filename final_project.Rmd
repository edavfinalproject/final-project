---
title: "Final Project"
author: "Names and Unis....."
date:   "April 24, 2018"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
                      message = FALSE, cache = TRUE)
```


### Introduction

The debate about whether human intervention is causing climate change is ending, but the search for how to avert its most harmful affects is just beginning. One of the primary casues of climate change is our burning of Fossil Fuels, which has been steadily growithing as showing in figure 1.

In the important book "Prosperity Without Growth" the Author Tim Jackson we must find a way to grow our prosperity, without continuing to use more and more resources. Keeping on the same trajectory is ultimitely unsustainable in that it will have catestrophic affects to our climate, or the resources will simply run out.

Many propoponts will say the problem is population. If we can find a way to stop population growth we could stop the growth of energy and become a more sustainable society. 

However, our team thinks this claim needs testing. Is it fair to blame the developing countries with high population growth when many western countires, especially the USA, are consuming far more energy per person? Does the correlation of population and energy shown above still hold true when all countries are not included? We believe exploratory data analysis is a fantastic tool to help answer these questions, and therefore **the primary goal of this project is to explore and define the characteristics of the relationship between energy use and population over time.** 

A secondary purpose of the project and presentaiton to the class is to showcase and important field that needs Data Science. In a field dominated by finance, advertising, marketing, sales, and tech for the sake of tech, we claim there is more to what a Data Scientist can do.


# TODO: List team members and a description of how each contributed to the project.
Our team includes:


* David Schemitsch
* Isaac Wainstein
* Wyatt Ford - 

### Description of Data

Our project uses three datasets below published by the World Bank. Each of these datasets contain per country data from 1960 through 2016. 

  1. Population, total
  2. Population growth (annual %)
  3. Energy use (kg of oil equivalent per capita)

In addition to these three dataset we added metadata of region and income group. We determined that including more data at this time would bring too much complexity for the scope of this project. However, we discuss additoinal metadata as part of the conclusion in the Future Work section.

The data was gathered and accessed using the World Bank's API, cleaned, and combined into one tidy dataframe. Making the tidy dataframe first was critical to collaboration. It allowed us all to have time to explore the data instead of waiting for a final dataset. Also, it made sure the code for the graphs would not change as the data format changed. Finally, it allowed us to easily make graphs with the data organized in the tidy format. Hence, having the dataset was large part of what made this project happen, and thus leads to future work of an R package discussed in the Future Work section.

The code to pull the data and put it in a data frame are below.

```{r}
# Install and/or load required libraries
needed_packages <- c("data.table", "tidyverse", "shiny")

for (p in needed_packages) {
     if (!(p %in% installed.packages())){
          install.packages(p)
     }
}

library(data.table)
library(tidyverse)
library(shiny)
```

```{r, results = "hide"}

### Download, unzip, and read in data stored as CSV files

#TODO Tidy the data

# Links for data sources
pop_growth_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.GROW?downloadformat=csv"
pop_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.TOTL?downloadformat=csv"
energy_zip <- "http://api.worldbank.org/v2/en/indicator/EG.USE.PCAP.KG.OE?downloadformat=csv"

# Download and unzip data sources
zip_list <- c(pop_growth_zip, pop_zip, energy_zip)

for (i in zip_list){
    
    td = tempdir()
    tf = tempfile(tmpdir=td, fileext=".zip")
    
    download.file(i, tf, mode = "wb")
    zip_folder <- unzip(tf, list = TRUE)
    
    for (j in seq_along(zip_folder$Name)) {
        
        file_name = unzip(tf, list = TRUE)$Name[j]
        unzip(tf, files = file_name, exdir = td, overwrite = TRUE)
        file_path <- file.path(td, file_name)
        csv <- fread(file_path)
        new_header <- str_to_upper(gsub(pattern = " ", replacement = "_", x = names(csv)))
        setnames(csv, new_header)
        assign(file_name, csv)
        
    }
    
}
```

```{r}
# Simplify data.frame names

pop_growth_df <-  API_SP.POP.GROW_DS2_en_csv_v2.csv
rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_growth_meta <- Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv
rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_growth_merged <- merge(pop_growth_df, subset(pop_growth_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")

pop_df <- API_SP.POP.TOTL_DS2_en_csv_v2.csv
rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_meta <- Metadata_Country_API_SP.POP.TOTL_DS2_en_csv_v2.csv
rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
pop_merged <- merge(pop_df, subset(pop_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")

energy_df <- API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
energy_df_meta <- Metadata_Country_API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
# rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
energy_merged <- merge(energy_df, subset(energy_df_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")

tidy_pop_energy <- rbind(pop_growth_merged, pop_merged, energy_merged)

tidy_pop_energy <- tidy_pop_energy %>% 
    gather(key = "YEAR", value = "VALUE", -COUNTRY_CODE, -COUNTRY_NAME,
           -INDICATOR_NAME, -INDICATOR_CODE, -REGION, -INCOMEGROUP) %>%
    mutate(YEAR = as.numeric(YEAR)) %>%
    mutate(VALUE = as.numeric(VALUE))

# Filter out rows where the country is not actually a country.

not_country = c("Arab World", "Central Europe and the Baltics", "Early-demographic dividend", "Europe & Central Asia (excluding high income)", "Euro area", "Fragile and conflict affected situations", "Heavily indebted poor countries (HIPC)", "IBRD only","IDA total", "Not classified", "Latin America & Caribbean (excluding high income)", "Latin America & Caribbean", "Low income", "Low & middle income", "Late-demographic dividend", "Middle income", "North America", "Post-demographic dividend", "Small states", "East Asia & Pacific (IDA & IBRD countries)", "Latin America & the Caribbean (IDA & IBRD countries)", "Middle East & North Africa (IDA & IBRD countries)", "South Asia (IDA & IBRD)", "World", "Upper middle income", "Sub-Saharan Africa (IDA & IBRD countries)", "Europe & Central Asia (IDA & IBRD countries)", "Sub-Saharan Africa", "Sub-Saharan Africa (excluding high income)", "Pacific island small states", "Pre-demographic dividend", "Other small states", "OECD members", "Middle East & North Africa (excluding high income)", "Middle East & North Africa", "Lower middle income", "Least developed countries: UN classification", "IDA only", "IDA blend", "IDA & IBRD total", "High income", "European Union", "Europe & Central Asia", "East Asia & Pacific", "East Asia & Pacific (excluding high income)", "Caribbean small states", "South Asia")

tidy_pop_energy <- filter(tidy_pop_energy, !COUNTRY_NAME %in% not_country)
# Sort dataframe by country name
tidy_pop_energy <- tidy_pop_energy %>% arrange(COUNTRY_NAME)
```

```{r}
pop_meta <- pop_meta[, .(COUNTRY_CODE, REGION, INCOMEGROUP)]

pop_df <- pop_df[,!"V63"]


pop_country_year <- pop_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "POP_GROWTH_RATE", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

energy_country_year <- energy_df %>%
    select(-COUNTRY_NAME, -INDICATOR_NAME, -INDICATOR_CODE) %>%
    gather(key = "YEAR", value = "ENERGY_USE", 
           -COUNTRY_CODE) %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))
```

### Analysis of Data Quality

Provide a detailed, well-organized description of data quality, including textual description, graphs, and code.

* For some years, total production by region is much higher than %100

There is a lot of missing data before 1971 and after 2012.

- line graph with three lines one for each indicator. Y is percent of missing values. X axis is year.
- histogram of percent of missing data. Each datapoint is a country
- see what David wrote

Add one of those visna() graphs for missing data

Discuss how data is limited to after 1960, and even then for "Energy Use" it's only a small portion of countries are represented in the earlier years, specifically high income countries. This limits inferences we can make about lower income countries in that decade, or long term inference across the whole of the 20th century. This could be displayed as table or bar chart of total count of nations per year in the three data sets. Maybe see if there are geographic/income-based patterns across the data, which would bias the results.

Talk about how in the meta files, there is a Special Notes column for descriptions on how the data was modified or revised. This might indicate the data isn't entirely accurate.

We explored using additional data from the World Bank, namely energy consumption by type as a percentage of total energy consumption. These data show what percentage of energy consumption is from nuclear, non-nuclear renewables, oil, natural gas, and coal. The data take the same format as the data we did use in this project. The initial intention behind using these consumption percentage data was to see if there are any connections between population growth, total energy use, and consumption habits. For example, one hypothethical correlation might be between quickly growing populations and heavy reliance on coal. However, we ultimately decided against using the consumption data in our final analysis.
    
### Main Analysis (Exploratory Data Analysis)

Provide a detailed, well-organized description of your findings, including textual description, graphs, and code.  Your focus should be on both the results and the process. Include, as reasonable and relevant, approaches that didn't work, challenges, the data cleaning process, etc.

The main analysis inovoles three sections
  1. Overview - High level representaiton of the growth of energy and poulation over time
  2. Interactive component - Tools to look at many facets of the data.
  3. Findings - Key insights learned and challanges faced. 

#### Overview


As shown in Figure 1 Energy use is growing. Many ay that we just need to replace our energy sources with clean, renewable sources. The International Energy Angency indicates today 13.2% of energy in the world comes from renewable sources. (https://www.iea.org/about/faqs/renewableenergy/). Therefore, to go 100% renwable we would need to increase out current capacity by 7.5 times. However, we see from 1975 to 2010 energy grows about 2.5 times, with a growrate of about 2.6%. If the growth rate stayed the same the energy use in 2100 would be over 8 times what it is today. Thefore, to go fully renewable with the current growth rate by 2100 means increaing out renable capacity by 64 times. Hence, an extremly important componnet is stopping our energy growth.


As shown in figure 2 population is also growing and energy per captia is not growing as much. We can conclude at a high level that since enrgy per captia is not incraeasing if we just stop population growth we stop energy growth. We think there is more to this story, which is the focus of the remainder of the Main anlaysis.


```{r echo = FALSE}
# Reform data
icodes = unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 100
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Alter dataset
icodes <- unique(tidy_pop_energy$INDICATOR_CODE)
my_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[2],]
my_data$VALUE <- as.numeric(my_data$VALUE)/1000000
my_data$YEAR <- as.numeric(my_data$YEAR)

# ENERGY GROWTH
energy_agg <- aggregate(energy_tot ~ YEAR, scatter_data, sum)
ggplot(energy_agg, aes(YEAR, energy_tot)) + geom_line() +
  labs(title="Energy Growth", 
       x="YEAR", 
       y="Energy use (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010))


# POPULATION GROWTH
pop_agg <- aggregate(pop_tot ~ YEAR, scatter_data, sum)
ggplot(pop_agg, aes(YEAR, pop_tot)) + geom_line() +
  labs(title="Population Growth", 
       x="YEAR", 
       y="Population (millions)") +
  coord_cartesian(xlim=c(1975, 2010))

# Per capita
energy_capita_agg <- aggregate(energy_percap ~ YEAR, scatter_data, mean)
energy_capita_agg$weighted <- energy_agg$energy_tot / pop_agg$pop_tot
ggplot(energy_capita_agg, aes(YEAR, weighted)) + geom_line() +
  labs(title="Energy per Capita", 
       x="YEAR", 
       y="Energy use per capita (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010))
```

```{r echo = FALSE}

```
#### Interactive component
As we started to determine what graph we should shown in this analysis, we quickly realized there were numerous insightful ways to show the data. Furthermore, there is no one chronological way to explain the data. Therefore, we chose to do R Shiny apps for our main analysis to allow the user to explore the data in many different ways. We present specific snapshots of the app in the Presentation section" to show insights that we found. Yet the shiny apps allow the user to discover their own conclusions as well.

We broke the data into there separate apps to explore these distinct aspects of the data. The three apps are listed below.

1. One country at a time....
  - Dropdown to select country
  - Shows graph of population, population growth, energy and energy growth over time
  - Dropdown for line graph or histogram
  
2. Distribution of population and energy across the world (David)
  - Each bar represents the value per country
  - Value select (population or energy use)
  - Slider bar on bottom for year

3. Scatter to compare energy and population growth rates (Isaac)
  - Each point is a country
  - Slider bar on bottom for year
  - X is energy growth rate
  - Y is population growth rate
  - Size of circle is size of population

```{r}
navbarPage("Good Graphics",
           tabPanel("Macroview",
                    sidebarLayout(
                        mainPanel(
                          plotOutput("countryhist")
                          ),
                        sidebarPanel(
                          selectInput(inputId = "tab1country", label = "Country:",
                                      choices = as.vector(unique(tidy_pop_energy$COUNTRY_NAME)), 
                                      selected = as.vector(unique(tidy_pop_energy$COUNTRY_NAME))[1])
                        )
                    )
                )
           ,
           tabPanel("TEST",
                    sidebarLayout(
                        sidebarPanel(
                            selectInput("n_breaks", label = "Number of bins:",
                                        choices = c(10, 20, 35, 50), selected = 20),
                            sliderInput("bw_adjust", label = "Bandwidth adjustment:",
                                        min = 0.2, max = 2, value = 1, step = 0.2)
                            ),
                        mainPanel(
                            plotOutput("hist")
                            )
                        )
                    )
           ,
           tabPanel("Distribution of Population and Energy",
                    sidebarLayout(
                        sidebarPanel(
                            radioButtons(label = "Indicator", inputId = "indicator",
                                         choices = c("Population Growth" = "Population growth (annual %)",
                                                     "Energy Use" = "Energy use (kg of oil equivalent per capita)",
                                                     "Total Population" = "Population, total"),
                                         selected = "Population growth (annual %)"),
                            
                            radioButtons(label = "Categories", inputId = "category",
                                         choices = c("Geographic Region" = "REGION",
                                                     "Income Group" = "INCOMEGROUP",
                                                     "None" = "INDICATOR_NAME"),
                                         selected = "INDICATOR_NAME"),
                            
                            sliderInput(inputId = "year",
                                        label = "Year:", 
                                        value = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                        min = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                        animate = animationOptions(interval = 250),
                                        max = max(tidy_pop_energy$YEAR, na.rm = TRUE),
                                        step = 1),
                            
                                  # Copy the line below to make a slider range 
                              sliderInput(inputId = "rank_slider", 
                                          label = "Slider Range", 
                                          min = 0, max = 1, value = c(0, 1))
                            
                            
                            
                            
                            ),
                        mainPanel(
                            plotOutput("ds_barplot")
                            )
                        )
                    )
           ,
           tabPanel("Growth Rate Scatter",
                      verticalLayout(
                        plotOutput("ds_scatter",  width = "100%"),
                        wellPanel(
                          sliderInput(inputId = "year_scatter",
                                      label = "Year:", 
                                      value = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                      min = 1971,
                                      max = 2012,
                                      step = 1),
                          sliderInput(inputId = "pop_max",
                                      label = "Max population:", 
                                      value = 1500,
                                      min = 0,
                                      max = 1500,
                                      step = 100),
                          sliderInput(inputId = "energy_max",
                                      label = "Max energy:", 
                                      value = 30000,
                                      min = 0,
                                      max = 30000,
                                      step = 2000)
                        )
                      )
           )
)
  #   tabPanel("Distribution of Population and Energy",
  #       sidebarLayout(
  #           sidebarPanel(
  #               selectInput("region", "Region:",
  #                           choices=colnames(WorldPhones)),
  #     hr(),
  #     helpText("Data from AT&T (1961) The World's Telephones.")
  #   ),
  #   
  #   # Create a spot for the barplot
  #   mainPanel(
  #     plotOutput("ds_barplot")  
  #   )
  #   
  # )
  #            
  # )

```






```{r echo = FALSE}
output$hist <- renderPlot({
  hist(faithful$eruptions, probability = TRUE, 
       breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", 
       main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```

```{r}
# Render a barplot

my_indicator <- reactive({input$indicator})
my_year <- reactive({input$year})
color_selection <- reactive({input$category})

rank_range <- reactive({input$rank_slider})

bar_colors <- c(`East Asia & Pacific` = "#F8766D",
                  `Latin America & Caribbean` = "#C49A00",
                  `North America` = "#53B400",
                  `Sub-Saharan Africa` = "#00C094",
                  `Europe & Central Asia` = "#00B6EB",
                  `Middle East & North Africa` = "#A58AFF",
                  `South Asia` = "#FB61D7",
                `High income` = "#238b45",
                   `Upper middle income` = "#66c2a4",
                   `Lower middle income` = "#b2e2e2",
                   `Low income` = "#edf8fb",
                `Population growth (annual %)` = "#999999",
                `Energy use (kg of oil equivalent per capita)` = "#999999", 
                `Population, total` = "#999999")



tidy_subset_barplot <- reactive({tidy_pop_energy %>%
        filter(INDICATOR_NAME == my_indicator() & YEAR == my_year()) %>%
        na.omit() %>%
        arrange(VALUE) %>%
        mutate(INCOMEGROUP = factor(INCOMEGROUP, levels = c("High income", "Upper middle income", 
                                                            "Lower middle income", "Low income"))) %>%
        mutate(value_percent_rank = percent_rank(VALUE)) %>%
        mutate(value_percent_rank = value_percent_rank - .0000001) %>%
        filter(value_percent_rank >= rank_range()[1] & value_percent_rank <= rank_range()[2])

})
# total_countries <- reactive({length(unique(tidy_subset_barplot$COUNTRY_CODE))})

output$ds_barplot <- renderPlot({
    ggplot(data = tidy_subset_barplot(), 
           aes(x = reorder(COUNTRY_CODE, VALUE), y = VALUE,
               fill = get(fill_selection()))) +
        geom_col() + xlab("Country") + ylab(my_indicator()) +
          scale_fill_manual(values=bar_colors)

})


```

```{r}
# Growth rate scatter


#TODOs
# Larger fonts
# Play button
# Button zoom in and out instead of slider.


# Reform data
icodes = unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 100
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Most energy using countries 
energy2012 <- scatter_data$energy_tot[scatter_data$YEAR == "2012"]
energy2012[is.na(energy2012)] <- 0
energy2012_total <- sum(energy2012)
sum(sort(energy2012, decreasing=TRUE)[0:5])/energy2012_total # top 20

# Config sliders
year_scatter <- reactive({input$year_scatter})
pop_max <- reactive({input$pop_max})
energy_max <- reactive({input$energy_max})

# Config data
tidy_subset <- reactive({scatter_data %>%
    filter(YEAR == year_scatter())
})

# Make plot
output$ds_scatter <- renderPlot({
    ggplot(data = tidy_subset(), aes(x=pop_tot, y=energy_tot, col=REGION)) +
        geom_point(size=5) + labs(title="Population vs. Energy Use", 
                            x="Population (millions)", 
                            y="Energy use (teragrams of oil equivelent)") + 
        coord_cartesian(xlim=c(0, pop_max()), ylim=c(0, energy_max())) +
        scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
        geom_text(aes(label=COUNTRY_NAME),hjust=-0.2, vjust=0)
}) 

#ggplot(scatter_data, aes(pop_growth, energy_tot)) + geom_point(size=scatter_data$pop_tot) + labs(title="Population Growth vs. Energy Use")

```

```{r}
# Tab1 Code

#create the dropdown 
tab1_countries <- reactive({input$tab1country})

# Population Total
tab1_total <- tidy_pop_energy %>% 
    filter(tidy_pop_energy$INDICATOR_NAME != "Population growth (annual %)") 
tab1_total_reactive <- reactive({filter(tab1_total, tab1_total$COUNTRY_NAME == tab1_countries())})

# render graph
output$countryhist <- renderPlot({
    ggplot(data=tab1_total_reactive(), aes(x=YEAR, y=VALUE)) + 
    geom_point() + geom_line() +
    facet_wrap(~INDICATOR_NAME, ncol=1, scale="free") +
    labs(title="Total Population over Time", x="Year")
})
```

```{r}
#CODE TRYING TO DEBUG FACET WRAP
usa_energy <- tidy_pop_energy %>% 
    filter(tidy_pop_energy$INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)", tidy_pop_energy$COUNTRY_NAME == "United States")
usa_pop <- tidy_pop_energy %>%
  filter(tidy_pop_energy$INDICATOR_NAME == "Population, total", tidy_pop_energy$COUNTRY_NAME == "United States")

usa_data <- tidy_pop_energy %>% filter(tidy_pop_energy$INDICATOR_NAME != "Population growth (annual %)", tidy_pop_energy$COUNTRY_NAME == "United States")

ggplot(data=usa_data, aes(x=YEAR, y=VALUE)) + geom_point() + facet_wrap(~usa_data$INDICATOR_CODE, ncol=1, scale="free")

# usa_total <- tab1_total %>% filter(tab1_total$COUNTRY_NAME == "United States", )

#ggplot(data=usa_total, aes(x=usa_total$YEAR, y=usa_total$VALUE)) +
#  facet_wrap(~usa_total$INDICATOR_NAME, scales="free") + geom_line() + geom_point()
```

#### Findings




Overall distribution of population and energy. 

#### No visible correlation
When broken down by country there is not a solid correlation between population and energy. 
	       	
Show your scatter plot zoomed and not zoomed
	       	
	       	
#### Different paths to high energy use
There are two paths to very high energy growth. One is Done by the US Where energy per capita is high but population does not grow. The second is by china where the population grows considerable and then per capita energy growth goes up. We can see this trend starting with other countries. For example, Egypt population is growing yet the energy growth is not drastically growing. This begs the question, what changed for china to slow down its population growth and change to energy growth?

#### Some countries didn't grow
There are also examples, such as Germany, where over the whole range there is little change in population and energy use. Needless the country has certainly had advances in health, technology, education, any more. Which leads to the question, what makes that country different from the rest?

#### Outliers
Three countries stand out from the rest. Why do these countries need to be different? Also over the 40 year span these countries are still the only ones separate. This leads me to believe that compounding (potentially capitalism) has influence.

 


```{r}
# Who are the big players?
# Histogram of population in latest year. Group all coutnries after top 100. Could also present in mosiac plot.
energy_2010=energy_country_year[energy_country_year$YEAR == "2010", ]
energy_2010$ENERGY_USE=as.numeric(energy_2010$ENERGY_USE)
energy_2010$YEAR=as.numeric(energy_2010$YEAR)
energy_2010 <- energy_2010[with(energy_2010, order(energy_2010$ENERGY_USE)),]

ggplot(energy_2010, aes(x=COUNTRY_CODE, y=ENERGY_USE)) + geom_bar(stat='sum') + labs(title="Population by Country", x="Country", y="Energy use (Btu?)")


# Histogram of energy in latest year.

# Repeat two above with mosaic plot

```

- Binned Histogram of 
  - Energy use and energy use per capita for latest year
  - Population and population growth rate for latest year
  - Population and energy growth rate across years for select countries
  


#### Take whats needed from below and then delete.
  
```{r}
# Scatter plot of energy use and growth rate by country-year
pop_energy_year <- 
    left_join(pop_country_year, energy_country_year, by = "COUNTRY_YEAR") %>%
    select(COUNTRY_YEAR, POP_GROWTH_RATE, ENERGY_USE) %>%
    filter(POP_GROWTH_RATE != '' & ENERGY_USE != '') %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
    mutate(ENERGY_USE = as.numeric(ENERGY_USE))

ggplot(pop_energy_year, aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point()


# Hard to tell what's going on without any subsetting.
# pop_elec_year <- 
#     left_join(pop_country_year, elec_access_country_year, by = "COUNTRY_YEAR") %>%
#     select(COUNTRY_YEAR, POP_GROWTH_RATE, ELECTRICITY_ACCESS) %>%
#     filter(POP_GROWTH_RATE != '' & ELECTRICITY_ACCESS != '') %>%
#     mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))

# ggplot(pop_elec_year, aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# ggplot(pop_elec_year %>% filter(POP_GROWTH_RATE >= 5), 
#        aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# Counts of countries by region and income group
#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(Region)) +
 #   geom_bar() + coord_flip()

#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(IncomeGroup)) +
 #   geom_bar() + coord_flip()


# Population growth rate over time by geographic region
pop_year_world <- pop_country_year %>%
    filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
                               "LCN", "ECS", "EAS")) %>%
    mutate(YEAR = as.integer(YEAR)) %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE))



ggplot(pop_year_world, 
       aes(YEAR, POP_GROWTH_RATE, color = COUNTRY_CODE)) + geom_line()

# elec_access_year_world <- elec_access_country_year %>%
#     filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS")) %>%
#     mutate(YEAR = as.integer(YEAR)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))


# No recorded values before 1990
# ggplot(elec_access_year_world %>% filter(YEAR >= 1990), 
#        aes(YEAR, ELECTRICITY_ACCESS, color = COUNTRY_CODE)) + geom_line()

```



```{r}

# world_prod_coal <- elec_prod_coal %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_hydro <- elec_prod_hydro %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_natural_gas <- elec_prod_natural_gas %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_nuclear <- elec_prod_nuclear %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_oil <- elec_prod_oil %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# world_prod_renewable <- elec_prod_renewable %>%
#      filter(COUNTRY_CODE %in% c("SSH", "SAS", "NAC", "MEA", 
#                                "LCN", "ECS", "EAS", "WLD"))
# 
# 
# world_prod_total <- rbind(world_prod_coal, world_prod_hydro, 
#                           world_prod_natural_gas, world_prod_nuclear,
#                           world_prod_oil, world_prod_renewable)
# 
# world_prod_total <- world_prod_total %>%
#      gather(key = "YEAR", value = "VALUE", -COUNTRY_NAME, -COUNTRY_CODE,
#             -INDICATOR_NAME, -INDICATOR_CODE) %>%
#      mutate(VALUE = as.numeric(VALUE)) %>%
#      mutate(YEAR = as.integer(YEAR)) %>%
#      left_join(y = pop_meta) %>%
#      drop_na()

# world_prod_total <- na.rm(world_prod_total)


# ggplot(world_prod_total %>% filter(COUNTRY_CODE == "WLD"),
#        aes(YEAR, VALUE, color = INDICATOR_CODE)) +
#      geom_line()
# 
# ggplot(world_prod_total,
#        aes(YEAR, VALUE, color = INDICATOR_CODE)) +
#      geom_line() + facet_wrap(facets = "COUNTRY_NAME")


# Data issue - for some years, total production by region is way above %100
# world_prod_total %>% 
#      group_by(COUNTRY_CODE, YEAR) %>% 
#      summarize(total = sum(VALUE)) %>%
#      arrange(-total)

```




### Executive Summary (Presentation-style)

Note: "Presentation" here refers to the style of graph, that is, graphs that are cleaned up for presentation, as opposed to the rough ones we often use for exploratory data analysis. You do not have to present your work to the class! However, you may choose to present your work as your community contribution, in which case you need to email me to set a date before the community contribution due date (Apr 3). (The presentation itself may be later.)

Provide a short nontechnical summary of the most revealing findings of your analysis  written for a nontechnical audience. The length should be approximately two pages (if we were using pages...) Take extra care to clean up your graphs, ensuring that best practices for presentation are followed.




### Conclusion

Discuss limitations and future directions, lessons learned.

#### Key findings
List our most insightful findings

#### Future work
There are certainly other factors in the relationship between population and energy use. These include economic, health, wealth, and many more. Including these factors in future analyses would be beneficial.

Our group sees this tidy dataframe as a product in itself. Talk about file size and how it organizes code and fits good in memory and simply provides the necessary work to analyze this. A good idea would be to make this into an r package. 

Create r package with dataset for others to contribute

Create open source avenue for collaborators to share their explorations of the data.

Future work could include additional metadata to further explore the relationship betweeen energy and population. For example economic indicators such as GDP, income and wealth. Health indicators such as life expectancy and birthrate. And finally energy sources such as solar, wind, coal, oil and end uses such as trasportation, residential, commercial, and industrial.

