---
title: "Final Project"
author: "David Schemitsch (ds3300), Isaac Wainstein (ikw2102), Wyatt Ford (wgf2102)"
date:   "April 24, 2018"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
                      message = FALSE)
```


### Introduction

The debate about whether human intervention is causing climate change is ending, but the search for how to avert its most harmful affects is just beginning. One of the primary casues of climate change is our burning of Fossil Fuels, which has been steadily growithing as showing in figure 1.

In the important book "Prosperity Without Growth" the Author Tim Jackson we must find a way to grow our prosperity, without continuing to use more and more resources. Keeping on the same trajectory is ultimitely unsustainable in that it will have catestrophic affects to our climate, or the resources will simply run out.

Many propoponts will say the problem is population. If we can find a way to stop population growth we could stop the growth of energy and become a more sustainable society. 

However, our team thinks this claim needs testing. Is it fair to blame the developing countries with high population growth when many western countires, especially the USA, are consuming far more energy per person? Does the correlation of population and energy shown above still hold true when all countries are not included? We believe exploratory data analysis is a fantastic tool to help answer these questions, and therefore **the primary goal of this project is to explore and define the characteristics of the relationship between energy use and population over time.** 

A secondary purpose of the project and presentaiton to the class is to showcase and important field that needs Data Science. In a field dominated by finance, advertising, marketing, sales, and tech for the sake of tech, we claim there is more to what a Data Scientist can do.


# TODO: List team members and a description of how each contributed to the project.
Our team includes:


* David Schemitsch
* Isaac Wainstein
* Wyatt Ford - 

### Description of Data

Our project uses three datasets below published by the [World Bank](https://data.worldbank.org/). Each of these datasets contain per country data from 1960 through 2016. 

  1. Population, total
  2. Population growth (annual %)
  3. Energy use (kg of oil equivalent per capita)

In addition to these three dataset we added metadata of region and income group. We determined that including more data at this time would bring too much complexity for the scope of this project. However, we discuss additoinal metadata as part of the conclusion in the Future Work section.

The data was gathered and accessed using the World Bank's API, cleaned, and combined into one tidy dataframe. Making the tidy dataframe first was critical to collaboration. It allowed us all to have time to explore the data instead of waiting for a final dataset. Also, it made sure the code for the graphs would not change as the data format changed. Finally, it allowed us to easily make graphs with the data organized in the tidy format. Hence, having the dataset was large part of what made this project happen, and thus leads to future work of an R package discussed in the Future Work section.

The code to pull the data and put it in a data frame are below. We explored two ways to access the data. Our initial method was to identify the URLs that link to the three datasets, then loop through those URLs to download, unzip, and read the data into R for processing. Due to the API's intermittant downtime, our next process for accessing the data was to use the [`WDI`](https://cran.r-project.org/web/packages/WDI/index.html) package. One advantage to using this package is that the data were already in long format. With the former method, we needed to convert the data frames from wide format.

When processing the data, we only kept the attributes we were interested in keeping, namely country name and code, year, region, and income group. The attribute names were cleaned up for consistency, and attributes were added to identify the indicator type (e.g. "Population growth (annual %)"). Next, the three data frames were unioned together into one tidy data frame. Lastly, we needed to remove rows that represented various collections of countries as identified by the World Bank (e.g. "Small states", "European Union"). While it would be interesting to see how these bins of countries interacted with the data, we needed to limit the scope of our exploration to geographic region and income group for the brevity's sake. 

```{r Install and/or load required libraries}
# Install and/or load required libraries
needed_packages <- c("data.table", "tidyverse", "shiny", "WDI", "extracat")

for (p in needed_packages) {
     if (!(p %in% installed.packages())){
          install.packages(p)
     }
    library(p, character.only = TRUE)
}

# library(data.table)
# library(tidyverse)
# library(shiny)
```

```{r download World Bank data via the WDI package}
 # Alternate way to download World Bank data via the WDI package

meta_df <- data.frame(WDI_data$country)
meta_df <- select(meta_df, iso3c, country, region, income)
setnames(meta_df, c("COUNTRY_CODE", "COUNTRY_NAME", "REGION", "INCOME"))

pop_growth_df <- WDI(country = "all", indicator = "SP.POP.GROW", 
                     start = 1960, end = 2017, extra = TRUE)
pop_growth_df <- select(pop_growth_df, country, SP.POP.GROW, year, iso3c, region, income)
setnames(pop_growth_df, c("COUNTRY_NAME", "VALUE", "YEAR", 
                          "COUNTRY_CODE", "REGION", "INCOMEGROUP"))
pop_growth_df <- pop_growth_df %>% mutate(INDICATOR_NAME = "Population growth (annual %)") %>%
    mutate(INDICATOR_CODE = "SP.POP.GROW")


pop_df <- WDI(country = "all", indicator = "SP.POP.TOTL", 
                     start = 1960, end = 2017, extra = TRUE)
pop_df <- select(pop_df, country, SP.POP.TOTL, year, iso3c, region, income)
setnames(pop_df, c("COUNTRY_NAME", "VALUE", "YEAR", 
                   "COUNTRY_CODE", "REGION", "INCOMEGROUP"))
pop_df <- pop_df %>% mutate(INDICATOR_NAME = "Population, total") %>%
    mutate(INDICATOR_CODE = "SP.POP.TOTL")



energy_df <- WDI(country = "all", indicator = "EG.USE.PCAP.KG.OE", 
                     start = 1960, end = 2017, extra = TRUE)
energy_df <- select(energy_df, country, EG.USE.PCAP.KG.OE, year, iso3c, region, income)
setnames(energy_df, c("COUNTRY_NAME", "VALUE", "YEAR", 
                      "COUNTRY_CODE", "REGION", "INCOMEGROUP"))
energy_df <- energy_df %>% mutate(INDICATOR_NAME = "Energy use (kg of oil equivalent per capita)") %>%
    mutate(INDICATOR_CODE = "EG.USE.PCAP.KG.OE")

tidy_pop_energy <- rbind(pop_growth_df, pop_df, energy_df)

tidy_pop_energy <- tidy_pop_energy %>% 
    mutate(YEAR = as.numeric(YEAR)) %>%
    mutate(VALUE = as.numeric(VALUE))

not_country = c("Arab World", "Central Europe and the Baltics", "Early-demographic dividend", "Europe & Central Asia (excluding high income)", "Euro area", "Fragile and conflict affected situations", "Heavily indebted poor countries (HIPC)", "IBRD only","IDA total", "Not classified", "Latin America & Caribbean (excluding high income)", "Latin America & Caribbean", "Low income", "Low & middle income", "Late-demographic dividend", "Middle income", "North America", "Post-demographic dividend", "Small states", "East Asia & Pacific (IDA & IBRD countries)", "Latin America & the Caribbean (IDA & IBRD countries)", "Middle East & North Africa (IDA & IBRD countries)", "South Asia (IDA & IBRD)", "World", "Upper middle income", "Sub-Saharan Africa (IDA & IBRD countries)", "Europe & Central Asia (IDA & IBRD countries)", "Sub-Saharan Africa", "Sub-Saharan Africa (excluding high income)", "Pacific island small states", "Pre-demographic dividend", "Other small states", "OECD members", "Middle East & North Africa (excluding high income)", "Middle East & North Africa", "Lower middle income", "Least developed countries: UN classification", "IDA only", "IDA blend", "IDA & IBRD total", "High income", "European Union", "Europe & Central Asia", "East Asia & Pacific", "East Asia & Pacific (excluding high income)", "Caribbean small states", "South Asia")

tidy_pop_energy <- filter(tidy_pop_energy, !COUNTRY_NAME %in% not_country)
tidy_pop_energy <- tidy_pop_energy %>% arrange(COUNTRY_NAME)

#Adding in energy total (for Tab1 Graphs)
# Divide population by 1000000 for scaling
pop_df <- pop_df %>% mutate(VALUE = VALUE/1000000) %>% 
  mutate(INDICATOR_NAME = c("Population (millions)"))
# Divide Energy per capita by 1000; rename to reflect new scale
energy_df <- energy_df %>% mutate(VALUE = VALUE/1000) %>%
  mutate(INDICATOR_NAME = c("Energy use per capita (teragrams of oil equivalent)"))

# Create energy_total column
energy_total_df <- energy_df %>% mutate(VALUE = VALUE * pop_df$VALUE) %>% mutate(INDICATOR_NAME = c("Energy use total (teragrams of oil equivalent)"))

tidy_pop_energy_for_tab_1 <- rbind(pop_growth_df, pop_df, energy_df, energy_total_df)
tidy_pop_energy_for_tab_1 <- tidy_pop_energy_for_tab_1 %>%
  mutate(YEAR = as.numeric(YEAR)) %>%
  mutate(VALUE = as.numeric(VALUE))

# Overview stats
tidy_overview <- filter(tidy_pop_energy_for_tab_1, COUNTRY_NAME %in% c("World", "East Asia & Pacific", "Europe & Central Asia", "Latin America & Caribbean", "Middle East & North Africa", "North America", "South Asia", "Sub-Saharan Africa"))
tidy_overview <- tidy_overview %>% arrange(COUNTRY_NAME)

tidy_pop_energy_for_tab_1 <- filter(tidy_pop_energy_for_tab_1, !COUNTRY_NAME %in% not_country)
tidy_pop_energy_for_tab_1 <- tidy_pop_energy_for_tab_1 %>% arrange(COUNTRY_NAME)
```


```{r Download, unzip, and read in data stored as CSV files, results="hide"}
# 
# ### Download, unzip, and read in data stored as CSV files
# 
# #TODO Tidy the data
# 
# # Links for data sources
# pop_growth_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.GROW?downloadformat=csv"
# pop_zip <- "http://api.worldbank.org/v2/en/indicator/SP.POP.TOTL?downloadformat=csv"
# energy_zip <- "http://api.worldbank.org/v2/en/indicator/EG.USE.PCAP.KG.OE?downloadformat=csv"
# 
# # Download and unzip data sources
# zip_list <- c(pop_growth_zip, pop_zip, energy_zip)
# 
# for (i in zip_list){
#     
#     td = tempdir()
#     tf = tempfile(tmpdir=td, fileext=".zip")
#     
#     download.file(i, tf, mode = "wb")
#     zip_folder <- unzip(tf, list = TRUE)
#     
#     for (j in seq_along(zip_folder$Name)) {
#         
#         file_name = unzip(tf, list = TRUE)$Name[j]
#         unzip(tf, files = file_name, exdir = td, overwrite = TRUE)
#         file_path <- file.path(td, file_name)
#         csv <- fread(file_path)
#         new_header <- str_to_upper(gsub(pattern = " ", replacement = "_", x = names(csv)))
#         setnames(csv, new_header)
#         assign(file_name, csv)
#         
#     }
#     
# }
```



```{r, eval=FALSE}
# Simplify data.frame names

# pop_growth_df <-  API_SP.POP.GROW_DS2_en_csv_v2.csv
# rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_growth_meta <- Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv
# rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_growth_merged <- merge(pop_growth_df, subset(pop_growth_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")
# 
# pop_df <- API_SP.POP.TOTL_DS2_en_csv_v2.csv
# rm(API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_meta <- Metadata_Country_API_SP.POP.TOTL_DS2_en_csv_v2.csv
# rm(Metadata_Country_API_SP.POP.GROW_DS2_en_csv_v2.csv)
# pop_merged <- merge(pop_df, subset(pop_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")
# 
# energy_df <- API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
# rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
# energy_df_meta <- Metadata_Country_API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv
# # rm(API_EG.USE.PCAP.KG.OE_DS2_en_csv_v2.csv)
# energy_merged <- merge(energy_df, subset(energy_df_meta, select=-c(4,5,6)), by = "COUNTRY_CODE")
# 
# tidy_pop_energy <- rbind(pop_growth_merged, pop_merged, energy_merged)
# 
# tidy_pop_energy <- tidy_pop_energy %>% 
#     gather(key = "YEAR", value = "VALUE", -COUNTRY_CODE, -COUNTRY_NAME,
#            -INDICATOR_NAME, -INDICATOR_CODE, -REGION, -INCOMEGROUP) %>%
#     mutate(YEAR = as.numeric(YEAR)) %>%
#     mutate(VALUE = as.numeric(VALUE))
# 
# # Filter out rows where the country is not actually a country.
# 
# not_country = c("Arab World", "Central Europe and the Baltics", "Early-demographic dividend", "Europe & Central Asia (excluding high income)", "Euro area", "Fragile and conflict affected situations", "Heavily indebted poor countries (HIPC)", "IBRD only","IDA total", "Not classified", "Latin America & Caribbean (excluding high income)", "Latin America & Caribbean", "Low income", "Low & middle income", "Late-demographic dividend", "Middle income", "North America", "Post-demographic dividend", "Small states", "East Asia & Pacific (IDA & IBRD countries)", "Latin America & the Caribbean (IDA & IBRD countries)", "Middle East & North Africa (IDA & IBRD countries)", "South Asia (IDA & IBRD)", "World", "Upper middle income", "Sub-Saharan Africa (IDA & IBRD countries)", "Europe & Central Asia (IDA & IBRD countries)", "Sub-Saharan Africa", "Sub-Saharan Africa (excluding high income)", "Pacific island small states", "Pre-demographic dividend", "Other small states", "OECD members", "Middle East & North Africa (excluding high income)", "Middle East & North Africa", "Lower middle income", "Least developed countries: UN classification", "IDA only", "IDA blend", "IDA & IBRD total", "High income", "European Union", "Europe & Central Asia", "East Asia & Pacific", "East Asia & Pacific (excluding high income)", "Caribbean small states", "South Asia")
# 
# tidy_pop_energy <- filter(tidy_pop_energy, !COUNTRY_NAME %in% not_country)
# # Sort dataframe by country name
# tidy_pop_energy <- tidy_pop_energy %>% arrange(COUNTRY_NAME)
```





### Analysis of Data Quality


There is a lot of missing data before 1971 and after 2012.

- line graph with three lines one for each indicator. Y is percent of missing values. X axis is year.
- histogram of percent of missing data. Each datapoint is a country
- see what David wrote


We represented missing data by using the `visna` function from the `extracat` package.
The `visna` graphs show the the population data is nearly complete, but the energy use data has a significant amount of missing data. Since the energy use data was the most incomplete, we broke out the data by income level to see if there are any discrepencies in reporting data based on this attribute. In fact, the most common pattern for low-income energy usage is that all yearly observations ar missing. This is not the case for the remaining three income brackets. This discrepancy shows that there are gaps in data collection in certain parts of the world, which will bias any findings that use these data.


```{r Energy use low-income}
wide_energy_low <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "Low income")
wide_energy_low <- select(wide_energy_low, YEAR, COUNTRY_CODE, VALUE)
wide_energy_low <- wide_energy_low %>% spread(YEAR, VALUE)

visna(wide_energy_low, sort = 'r')
```


```{r Energy use lower-middle income}
wide_energy_low_mid <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "Lower middle income")
wide_energy_low_mid <- select(wide_energy_low_mid, YEAR, COUNTRY_CODE, VALUE)
wide_energy_low_mid <- wide_energy_low_mid %>% spread(YEAR, VALUE)

visna(wide_energy_low_mid, sort = 'r')

```

```{r Energy use Upper-middle income}
wide_energy_up_mid <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "Upper middle income")
wide_energy_up_mid <- select(wide_energy_up_mid, YEAR, COUNTRY_CODE, VALUE)
wide_energy_up_mid <- wide_energy_up_mid %>% spread(YEAR, VALUE)

visna(wide_energy_up_mid, sort = 'r')

```

```{r Energy use high income}
wide_energy_up <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Energy use (kg of oil equivalent per capita)" & 
                          INCOMEGROUP == "High income")
wide_energy_up <- select(wide_energy_up, YEAR, COUNTRY_CODE, VALUE)
wide_energy_up <- wide_energy_up %>% spread(YEAR, VALUE)

visna(wide_energy_up, sort = 'r')

```


```{r population growth and total population}
# Convert tidy data to wide and segment by indicator to get a better picture of missing data
# patterns across time

wide_pop_total <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Population, total")
wide_pop_total <- select(wide_pop_total, YEAR, COUNTRY_CODE, VALUE)
wide_pop_total <- wide_pop_total %>% spread(YEAR, VALUE)
visna(wide_pop_total, sort = 'r')

wide_pop_growth <- filter(tidy_pop_energy, 
                      INDICATOR_NAME == "Population growth (annual %)")
wide_pop_growth <- select(wide_pop_growth, YEAR, COUNTRY_CODE, VALUE)
wide_pop_growth <- wide_pop_growth %>% spread(YEAR, VALUE)
visna(wide_pop_growth, sort = 'r')
```

To get a broad sense of the interaction between energy consumption and total population, we created new variable for the concatenation of country and year. This technique creates a unique identifier for each observation. It is difficult to see general patterns initially due to outliers, so we removed these in a second scatterplot.

```{r Scatter plot of energy use and growth rate by country-year}
# Scatter plot of energy use and growth rate by country-year


pop_country_year <- pop_df %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

energy_country_year <- energy_df %>%
    mutate(COUNTRY_YEAR = paste0(COUNTRY_CODE,"_",YEAR))

pop_country_year <- pop_country_year %>% mutate(POP_GROWTH_RATE = VALUE)
energy_country_year <- energy_country_year %>% mutate(ENERGY_USE = VALUE)

pop_energy_year <- 
    left_join(pop_country_year, energy_country_year, by = "COUNTRY_YEAR") %>%
    select(COUNTRY_YEAR, POP_GROWTH_RATE, ENERGY_USE) %>%
    filter(POP_GROWTH_RATE != '' & ENERGY_USE != '') %>%
    mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
    mutate(ENERGY_USE = as.numeric(ENERGY_USE))

ggplot(pop_energy_year, aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point(alpha = .1) + geom_density_2d()

ggplot(pop_energy_year %>% filter(ENERGY_USE <= 10000 & POP_GROWTH_RATE <= 2e+07),
       aes(POP_GROWTH_RATE, ENERGY_USE)) + 
    geom_point(alpha = .1) + geom_density_2d()




# Hard to tell what's going on without any subsetting.
# pop_elec_year <- 
#     left_join(pop_country_year, elec_access_country_year, by = "COUNTRY_YEAR") %>%
#     select(COUNTRY_YEAR, POP_GROWTH_RATE, ELECTRICITY_ACCESS) %>%
#     filter(POP_GROWTH_RATE != '' & ELECTRICITY_ACCESS != '') %>%
#     mutate(POP_GROWTH_RATE = as.numeric(POP_GROWTH_RATE)) %>%
#     mutate(ELECTRICITY_ACCESS = as.numeric(ELECTRICITY_ACCESS))

# ggplot(pop_elec_year, aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# ggplot(pop_elec_year %>% filter(POP_GROWTH_RATE >= 5), 
#        aes(ELECTRICITY_ACCESS, POP_GROWTH_RATE)) + 
#     geom_point()

# Counts of countries by region and income group
#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(Region)) +
 #   geom_bar() + coord_flip()

#ggplot(pop_meta %>% filter(IncomeGroup != ""), aes(IncomeGroup)) +
 #   geom_bar() + coord_flip()




```

Discuss how data is limited to after 1960, and even then for "Energy Use" it's only a small portion of countries are represented in the earlier years, specifically high income countries. This limits inferences we can make about lower income countries in that decade, or long term inference across the whole of the 20th century. This could be displayed as table or bar chart of total count of nations per year in the three data sets. Maybe see if there are geographic/income-based patterns across the data, which would bias the results.

Talk about how in the meta files, there is a Special Notes column for descriptions on how the data was modified or revised. This might indicate the data isn't entirely accurate.

We explored using additional data from the World Bank, namely energy consumption by type as a percentage of total energy consumption. These data show what percentage of energy consumption is from nuclear, non-nuclear renewables, oil, natural gas, and coal. The data take the same format as the data we did use in this project. The initial intention behind using these consumption percentage data was to see if there are any connections between population growth, total energy use, and consumption habits. For example, one hypothethical correlation might be between quickly growing populations and heavy reliance on coal. However, we ultimately decided against using the consumption data in our final analysis.
    
### Main Analysis (Exploratory Data Analysis)

The main analysis section has been split into the following subsecitons.
  1. **Overview** - High level representaiton of the relaitonship between energy and population over time.
  2. **Interactive component** - Tools for observing numerous facets of the data.
  3. **Findings** - Key insights and challanges the team faced. 

#### Overview
As shown in Figure 1-4, energy use is consistently growing. As today the The International Energy Angency reports  that 13.2% of energy in the world comes from renewable sources. (https://www.iea.org/about/faqs/renewableenergy/). Therefore, to replace our energy consumption with 100% clean, renewable source we need to increase our current capacity by 7.5 times. However, we learn from Figure 1-4 that energy consumption has growth approximitely 2.5 times from 1975 to 2010 at a growth rate of 2.6%. If the growth rate stayed the same the energy use in 2100 would be over 8 times what it is today. Thefore, to go 100% clean energy by 2100 would require increasing clean energy capcity by 64 times. 

```{r echo = FALSE}
# Reform data
icodes <-  unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 1000
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Alter dataset
icodes <- unique(tidy_pop_energy$INDICATOR_CODE)
my_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[2],]
my_data$VALUE <- as.numeric(my_data$VALUE)/1000000
my_data$YEAR <- as.numeric(my_data$YEAR)

# ENERGY GROWTH
energy_agg <- aggregate(energy_tot ~ YEAR, scatter_data, sum)
ggplot(energy_agg, aes(YEAR, energy_tot)) + geom_line() +
  labs(title="Figure 4-1. Energy Growth", 
       x="YEAR", 
       y="Energy use (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010)) + 
  scale_y_continuous(labels = scales::comma)

```

Therefore, for society to go 100% clean energy we need to slow our energy growth as well. One approach to slowing energy growth is to slow population as well. Figure 4-2 shows that population also consistently growing, while energy use per-capita (Figure 4-3) has only shown moderate growth. The slow growth of energy per-captia shows that our improvements in energy efficiency are keeping up with our demand for more power. Hence, if we could just stop population growth we stop energy growth. 

```{r echo = FALSE}
# POPULATION GROWTH
pop_agg <- aggregate(pop_tot ~ YEAR, scatter_data, sum)
ggplot(pop_agg, aes(YEAR, pop_tot)) + geom_line() +
  labs(title="Population Growth", 
       x="YEAR", 
       y="Population (millions)") +
  coord_cartesian(xlim=c(1975, 2010)) +
  scale_y_continuous(labels = scales::comma)


# Per capita
energy_capita_agg <- aggregate(energy_percap ~ YEAR, scatter_data, mean)
energy_capita_agg$weighted <- energy_agg$energy_tot / pop_agg$pop_tot
ggplot(energy_capita_agg, aes(YEAR, weighted)) + geom_line() +
  labs(title="Energy per Capita", 
       x="YEAR", 
       y="Energy use per capita (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010))
```

Yet when we look at figures such as 3-# and 3-# (the scatter plot in data quality section) we learn that when we split by country the smooth coorelation immediately goes away. In the remainder of the main analysis we provide interactive tools explore the relationship between energy growth and populaiton, and then present our main findings from using the tools we made.

#### Interactive component
As we started to determine what graphs we should shown in this analysis, we quickly realized there were so many insightful ways we could split the data the report would either be too long or skipping key insights. Therefore, we chose to do interactive R Shiny apps for the main part of our analysis. This allowed our team to easily explore the data, while also allowing users to explore in ways we had not yet thought of. 

We broke the data into there separate apps to explore these distinct aspects of the data. We often found ourselves jumping back and forth, and encourage users to do the same, as each story of the data does not need to go in chronological order. The three apps are listed below.

  1. **Individual Country** - Deep divy into how population and energy has changed over time for one country.
  2. **Country Comparison** - Presents countries side-by-side in a way where magnitudes of energy and population can be easily compared over time.
  3 **Energy vs. Population** - Presents energy vs population in a scatter plot to visualize correlations over time. 
  
The idea to include a year slider was inspired by the follwoing TED talk.
https://www.gapminder.org/videos/ted-us-state-department/ 

The code below creates the Layout for the navigation bar.

```{r NavBar}
# Shiny Layour
navbarPage("Interactive Component",
           tabPanel("Individual Country",
                    verticalLayout(
                          plotOutput("countryhist", width="100%", height = "500px"),
                        wellPanel(
                          selectInput(inputId = "tab1country", label = "Country:",
                                      choices = as.vector(unique(tidy_pop_energy$COUNTRY_NAME)), 
                                      selected = as.vector(unique(tidy_pop_energy$COUNTRY_NAME))[1])
                        )
                    )
                )
           ,
           tabPanel("Country Comparison",
                    
                        verticalLayout(
                            plotOutput("ds_barplot", width = "100%"),
                            fluidRow(
                                column(
                            radioButtons(label = "Indicator", inputId = "indicator",
                                         choices = c("Population Growth" = "Population growth (annual %)",
                                                     "Energy Use" = "Energy use (kg of oil equivalent per capita)",
                                                     "Total Population" = "Population, total"),
                                         selected = "Population growth (annual %)"), width = 3),
                            column(
                            radioButtons(label = "Categories", inputId = "category",
                                         choices = c("Geographic Region" = "REGION",
                                                     "Income Group" = "INCOMEGROUP",
                                                     "None" = "INDICATOR_NAME"),
                                         selected = "INDICATOR_NAME"), width = 3),
                            column(
                            sliderInput(inputId = "year",
                                        label = "Year:", 
                                        value = 1961,
                                        min = 1961,
                                        animate = animationOptions(interval = 333),
                                        max = 2016,
                                        step = 1), width = 3),
                            
                                  # Copy the line below to make a slider range 
                            column(
                              sliderInput(inputId = "rank_slider", 
                                          label = "Percentage slice", 
                                          min = 0, max = 1, value = c(0, 1)),width = 3)
                            )
                        )
                    )
           ,
           tabPanel("Energy vs. Population",
                      verticalLayout(
                        plotOutput("ds_scatter",  width = "100%"),
                        wellPanel(
                          sliderInput(inputId = "year_scatter",
                                      label = "Year:", 
                                      value = min(tidy_pop_energy$YEAR, na.rm = TRUE),
                                      min = 1971,
                                      max = 2012,
                                      step = 1),
                          sliderInput(inputId = "pop_max",
                                      label = "Max population:", 
                                      value = 1500,
                                      min = 0,
                                      max = 1500,
                                      step = 100),
                          sliderInput(inputId = "energy_max",
                                      label = "Max energy:", 
                                      value = 3000,
                                      min = 0,
                                      max = 3000,
                                      step = 2000)
                        )
                      )
           )
)

```


The Code below renders the figures in the shiny app.

```{r Bar Plot tab}
# Country Comparison.

my_indicator <- reactive({input$indicator})
my_year <- reactive({input$year})
fill_selection <- reactive({input$category})

rank_range <- reactive({input$rank_slider})

bar_colors <- c(`East Asia & Pacific` = "#F8766D",
                `Latin America & Caribbean` = "#C49A00",
                `North America` = "#53B400",
                `Sub-Saharan Africa` = "#00C094",
                `Europe & Central Asia` = "#00B6EB",
                `Middle East & North Africa` = "#A58AFF",
                `South Asia` = "#FB61D7",
                `High income` = "#238b45",
                `Upper middle income` = "#66c2a4",
                `Lower middle income` = "#b2e2e2",
                `Low income` = "#edf8fb",
                `Population growth (annual %)` = "#999999",
                `Energy use (kg of oil equivalent per capita)` = "#999999", 
                `Population, total` = "#999999")

tidy_barplot <- tidy_pop_energy

tidy_barplot <- tidy_barplot %>% select(COUNTRY_NAME, YEAR, COUNTRY_CODE,
                                        REGION, INCOMEGROUP, INDICATOR_NAME,
                                        INDICATOR_CODE, VALUE)

tidy_barplot_energy_tot <- scatter_data %>% 
     select(COUNTRY_NAME, YEAR, COUNTRY_CODE,
            REGION, INCOMEGROUP, INDICATOR_NAME,
            INDICATOR_CODE, energy_tot)

setnames(tidy_barplot_energy_tot, "energy_tot", "VALUE")

tidy_barplot_energy_tot <- filter(tidy_barplot_energy_tot,
                                  !is.na(VALUE))
     
tidy_barplot <- rbind(tidy_barplot, tidy_barplot_energy_tot)


tidy_subset_barplot <- reactive({tidy_pop_energy %>%
        filter(INDICATOR_NAME == my_indicator() & YEAR == my_year()) %>%
        na.omit() %>%
        arrange(VALUE) %>%
        mutate(INCOMEGROUP = factor(INCOMEGROUP, levels = c("High income", "Upper middle income", 
                                                            "Lower middle income", "Low income"))) %>%
        mutate(value_percent_rank = percent_rank(VALUE)) %>%
        mutate(value_percent_rank = value_percent_rank - .0000001) %>%
        filter(value_percent_rank >= rank_range()[1] & value_percent_rank <= rank_range()[2])

})
# total_countries <- reactive({length(unique(tidy_subset_barplot$COUNTRY_CODE))})

output$ds_barplot <- renderPlot({
    ggplot(data = tidy_subset_barplot(), 
           aes(x = reorder(COUNTRY_CODE, VALUE), y = VALUE,
               fill = get(fill_selection()))) +
        geom_col() + xlab("Country") + ylab(my_indicator()) +
          scale_fill_manual(values = bar_colors, name = "Categories")

})


```

```{r Scatter Plot tab}
# Energy vs. Population

# Reform data
icodes = unique(tidy_pop_energy$INDICATOR_CODE)
scatter_data <- tidy_pop_energy[tidy_pop_energy$INDICATOR_CODE == icodes[1],]
scatter_data$pop_growth <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[1]])
scatter_data$pop_tot <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[2]])/1000000
scatter_data$energy_percap <- as.numeric(tidy_pop_energy$VALUE[tidy_pop_energy$INDICATOR_CODE == icodes[3]])
scatter_data$energy_tot <- (scatter_data$energy_percap * scatter_data$pop_tot) / 1000
scatter_data <- scatter_data[complete.cases(scatter_data), ]

# Most energy using countries 
energy2012 <- scatter_data$energy_tot[scatter_data$YEAR == "2010"]
energy2012[is.na(energy2012)] <- 0
energy2012_total <- sum(energy2012)
sum(sort(energy2012, decreasing=TRUE)[0:2])/energy2012_total # top 2

# Config sliders
year_scatter <- reactive({input$year_scatter})
pop_max <- reactive({input$pop_max})
energy_max <- reactive({input$energy_max})

# Config data
tidy_subset <- reactive({scatter_data %>%
    filter(YEAR == year_scatter())
})

# Make plot
output$ds_scatter <- renderPlot({
    ggplot(data = tidy_subset(), aes(x=pop_tot, y=energy_tot, col=REGION)) +
        geom_point(size=5) + labs(title="Population vs. Energy Use", 
                            x="Population (millions)", 
                            y="Energy use (teragrams of oil equivelent)") + 
        coord_cartesian(xlim=c(0, pop_max()), ylim=c(0, energy_max())) +
        scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
        geom_text(aes(label=COUNTRY_NAME),hjust=-0.2, vjust=0)
}) 

#ggplot(scatter_data, aes(pop_growth, energy_tot)) + geom_point(size=scatter_data$pop_tot) + labs(title="Population Growth vs. Energy Use")

```

``` {r }
tab1_overview <- tidy_overview %>%
  filter(tidy_overview$INDICATOR_NAME != "Population growth (annual %)") 

ggplot(data=tab1_overview, aes(x=YEAR, y=VALUE)) +
  geom_point() +
  facet_wrap(~INDICATOR_NAME, ncol=2, scale="free") +
  scale_fill_manual(values = bar_colors, name = "Categories")



```

```{r Tab 1}
#create the dropdown 
tab1_countries <- reactive({input$tab1country})

# Tab1 Code
tab1_messy <- subset(scatter_data, select=c("COUNTRY_NAME", "YEAR", "pop_growth", "pop_tot", "energy_percap", "energy_tot"))

tab1_tidy <- tab1_messy %>% gather(key="indicator_name", value="indicator_value", -YEAR, -COUNTRY_NAME)
tab1_tidy_reactive <- reactive({filter(tab1_tidy, COUNTRY_NAME == tab1_countries())})

# Population Total
tab1_total <- tidy_pop_energy_for_tab_1 
tab1_total_reactive <- reactive({filter(tab1_total, tab1_total$COUNTRY_NAME == tab1_countries())})

# render graph
output$countryhist <- renderPlot({
    ggplot(data=tab1_total_reactive(), aes(x=YEAR, y=VALUE)) + 
    geom_point() + geom_line() +
    facet_wrap(~INDICATOR_NAME, ncol=1, scale="free") +
    labs(title="Values by Country", x="Year")
})
```

#### Findings

In these section we present our findings from our exploration of the data and the interactive tools.

##### Weak correlation
The stead growth of population and energy lead us to believe there was likely a strong correlation. However, Figure 4-# and 4-# indicate that although there is a direct relationship, the correlation is not strong. Therefore, there is lots of variation in the relationship between energy and popualtion amound contries. 

```{r}
# No zoom
ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x=pop_tot, y=energy_tot, col=REGION)) +
  geom_point(size=5) + 
  labs(title="Figure 4-#. Energy vs. Population (2010)",
       x="Population (millions)",
       y="Energy use (teragrams of oil equivelent)") + 
  coord_cartesian(xlim=c(0, 1500), ylim=c(0, 3000)) +
  scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
  geom_text(aes(label=COUNTRY_NAME), hjust=-0.2, vjust=0)

# zoom
ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x=pop_tot, y=energy_tot, col=REGION)) +
  geom_point(size=5) + 
  labs(title="Figure 4-#. Energy vs. Population, Zoomed (2010)",
       x="Population (millions)",
       y="Energy use (teragrams of oil equivelent)") + 
  coord_cartesian(xlim=c(0, 75), ylim=c(0, 100)) +
  scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
  geom_text(aes(label=COUNTRY_NAME), hjust=-0.2, vjust=0)

```
	       	
#### Distribution across countires
We immediately notice from Figure 4-# there is large inequality of energy use. China and USA are the two outliers accounting for nearly 40% of the energy use from those countries alone. The top 10 countires account for 65% and the top 50 account for 93%. This indicates our energy use is high concentrated.

```{r}

ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x = reorder(COUNTRY_CODE, energy_tot), y = energy_tot)) +
  geom_col() +   
  labs(title="Figure 4-#. Distribution of Energy (2010)",
       x="Country",
       y="Energy use (teragrams of oil equivelent)") + 
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x=element_blank())

```


The population has high ineqality as well, yet the two outlying countries are now India and China. These two countries account for 38% of the total population. The top 10 account for 61% of the population and top 50 account for 91% of the populaiton. Again, we learn the that although there are houndres of countires, the overal story described in the Overview section is being driven by a small number of countries.

```{r}

ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x = reorder(COUNTRY_CODE, pop_tot), y = pop_tot)) +
  geom_col() +   
  labs(title="Figure 4-#. Distribution of Population (2010)",
       x="Country",
       y="Population (Millions)") + 
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x=element_blank())

```

     	
#### Different paths
When we look at the three standout contries (United States, China, India) we distinct paths to high energy use. The United States grew its energy use without large increases in populaiton. Conversely, China first grew its populaiton and then later the rate of population growth slowed and the energy use per capita grew. India seems on a similar path as China, with its population growth about to slow and energy use per captia about to rise. Further research into what causes these various paths could help countries design more sustainable trajectories. 

```{r}
# Make plot
ggplot(data = scatter_data[scatter_data$COUNTRY_NAME %in% c("China", "United States", "India"), ], 
       aes(x=pop_tot, y=energy_tot, col=COUNTRY_NAME)) +
  geom_point(size=5) + 
  labs(title="Figure 4-#. Paths of Energy Growth",
       x="Population (millions)",
       y="Energy use (teragrams of oil equivelent)") + 
  coord_cartesian(xlim=c(0, 1500), ylim=c(0, 3000)) +
  scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma)

```

#### Ethics of change
Countires such as the United Kingdom are seing the energy use per capita shrink. Conversely, we a less developed country such as Indonesia has rapid stead growth in energy use per captia. THis may lead us to believe that United Kingdom is on a good path, while the tregectory of Indonesia needs to change. However, the United Kindom's current energy use per-capita is three times higher than Indonisia. Hence, is it fair to say they do not deserve to growth their country to the same level? This is one of many ethica delemmas that we must face as we find sustainable paths for all countires.

```{r}
# United Kingdom
ggplot(data = scatter_data[scatter_data$COUNTRY_NAME == "United Kingdom", ], 
       aes(x=YEAR, y=energy_percap)) +
  geom_line() + 
  labs(title="Figure 4-#. Energy Use Per-Capita (United Kingdom)",
       x="Year",
       y="Energy use per capita (teragrams of oil equivelent)") + 
  scale_y_continuous(labels = scales::comma)

# Indonesia
ggplot(data = scatter_data[scatter_data$COUNTRY_NAME == "Indonesia", ], 
       aes(x=YEAR, y=energy_percap)) +
  geom_line() + 
  labs(title="Figure 4-#. Energy Use Per-Capita (Indonesia)",
       x="Year",
       y="Energy use per capita (teragrams of oil equivelent)") + 
  scale_y_continuous(labels = scales::comma)

```


#### Challanges
- Plotting many counties at same time
- Narrowing down the endless possability of graphs. Making sure the graph is meaningful


### Executive Summary (Presentation-style)

Moving towards the 100% clean energy will require immense research into the relationship between energy and population in order for each country to succesfully design and follow their paths to sustainability. In this executive summary we present our key findings from exploring this relationship for future researches to build open as they search for sustainable paths. We also hope this story encourages researches to use the interactive tools above to create their own stories about the relationship between populaiton and energy use.

Figure 5-1 and 5-2 show steady growth of both energy and population. Figure 5-3 shows there is a strong relaship between these two variables.

```{r}
# Energy growth
energy_agg <- aggregate(energy_tot ~ YEAR, scatter_data, sum)
ggplot(energy_agg, aes(YEAR, energy_tot)) + geom_line() +
  labs(title="Figure 4-1. Energy and Population Growth", 
       x="YEAR", 
       y="Energy use (teragrams of oil equivelent)") +
  coord_cartesian(xlim=c(1975, 2010)) +
  theme(axis.text.x=element_blank())

# Population growth
pop_agg <- aggregate(pop_tot ~ YEAR, scatter_data, sum)
ggplot(pop_agg, aes(YEAR, pop_tot)) + geom_line() +
  labs(title="Population Growth", 
       x="YEAR", 
       y="Population (millions)") +
  coord_cartesian(xlim=c(1975, 2010)) +
  theme(axis.text.x=element_blank())

pop_energy_agg <- cbind(pop_agg, energy_agg)
ggplot(data = pop_energy_agg, 
       aes(x=pop_tot, y=energy_tot)) +
  geom_point(size=5) + 
  labs(title="Figure 4-#. World Energy vs. Population",
       x="Population (millions)",
       y="Energy use (teragrams of oil equivelent)") + 
  scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x=element_blank())

```

However, we see there is a lot of information hidden when average over the entire world. Figure 5-3 below shows the relationship between energy use and population for each country in 2010.

```{r}
ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x=pop_tot, y=energy_tot, col=REGION)) +
  geom_point(size=5) + 
  labs(title="Figure 4-#. Energy vs. Population (2010)",
       x="Population (millions)",
       y="Energy use (teragrams of oil equivelent)") + 
  coord_cartesian(xlim=c(0, 1500), ylim=c(0, 3000)) +
  scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma) +
  geom_text(aes(label=COUNTRY_NAME), hjust=-0.2, vjust=0)

```

From the scatter we immediately see there are ouliers. Figures 5-4 and 5-5 below show the inequal distribution of energy and populaiton. For example, China and the US account for X% of the worlds energy use, and CHina and India account for X% of the worlds population.

```{r}

ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x = reorder(COUNTRY_CODE, energy_tot), y = energy_tot)) +
  geom_col() +   
  labs(title="Figure 4-#. Distribution of Energy (2010)",
       x="Country",
       y="Energy use (teragrams of oil equivelent)") + 
  scale_y_continuous(labels = scales::comma)

ggplot(data = scatter_data[scatter_data$YEAR == 2010, ], 
       aes(x = reorder(COUNTRY_CODE, pop_tot), y = pop_tot)) +
  geom_col() +   
  labs(title="Figure 4-#. Distribution of Population (2010)",
       x="Country",
       y="Population (Millions)") + 
  scale_y_continuous(labels = scales::comma)

```


We can see these countries took different path to be outliers.
```{r}
# Make plot
ggplot(data = scatter_data[scatter_data$COUNTRY_NAME %in% c("China", "United States", "India"), ], 
       aes(x=pop_tot, y=energy_tot, col=COUNTRY_NAME)) +
  geom_point(size=5) + 
  labs(title="Figure 4-#. Paths of Energy Growth",
       x="Population (millions)",
       y="Energy use (teragrams of oil equivelent)") + 
  coord_cartesian(xlim=c(0, 1500), ylim=c(0, 3000)) +
  scale_x_continuous(labels = scales::comma) + scale_y_continuous(labels = scales::comma)

```

We need to determien the right path for each country. Below we see the United Kindom has decreasing energy use per captia while Indonesia is increasing. yet looking closely reveals that the United Kindom has three times the enrgy use per captia as Indonisia. Hence, should we be trying to shrink the UK to Indoneia? Is it fiar tolet Indonesia to get to the level fo teh UK?  These are just some of the ethical quesitons we must face as we find sustainable paths for all countires.

```{r}
# United Kingdom
ggplot(data = scatter_data[scatter_data$COUNTRY_NAME == "United Kingdom", ], 
       aes(x=YEAR, y=energy_percap)) +
  geom_line() + 
  labs(title="Figure 4-#. Energy Use Per-Capita (United Kingdom)",
       x="Year",
       y="Energy use per capita (teragrams of oil equivelent)") + 
  scale_y_continuous(labels = scales::comma)

# Indonesia
ggplot(data = scatter_data[scatter_data$COUNTRY_NAME == "Indonesia", ], 
       aes(x=YEAR, y=energy_percap)) +
  geom_line() + 
  labs(title="Figure 4-#. Energy Use Per-Capita (Indonesia)",
       x="Year",
       y="Energy use per capita (teragrams of oil equivelent)") + 
  scale_y_continuous(labels = scales::comma)

```

### Conclusion
Our biggest lession learned was our hypothesis that the strong direct relationship between energy and popualtion growth was not the full story was correct. Simply when breaking down by year the correlation was less visible. We hope this inspires other as our team has been to think deeply about how popualiton and energy factor into our paths to sustainability.

Our team was inspired by depth of what could be explored with just the variable energy use, population, year, and country. Nonetheless there are numerous other factors in the relationship between population and energy use. These include economic, health, wealth, and many more. Including these factors in future analyses would be beneficial. Yet the numerous insights is also a challange. There are many figures that can be made that are not insightful or can be misleading. 

Our group quickly relized the tidy dataframe could inspire collaboration beyond our team. Future work could involve orgianzing all the data soruces into an organized database with APIs for R, Python, and othe languages for researches to use. Furthermore we could create an online environment for researchs to share their explorations of the data. We believe this collaboration could greatly enhance countries to successfully define their paths to sustainability. 



